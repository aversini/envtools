#!/usr/bin/env node
'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a},VERSION='9.0.4',p=console.warn,util=require('util'),assert=require('assert'),path=require('path'),vm=require('vm'),fs=require('fs'),warn=console.warn,EventEmitter=require('events').EventEmitter;exports.main=main,exports.getVersion=getVersion,exports.parseLookup=parseLookup,exports.lookupDatum=lookupDatum,exports.printDatum=printDatum;var OM_JSONY=1,OM_JSON=2,OM_INSPECT=3,OM_COMPACT=4,OM_FROM_NAME={jsony:OM_JSONY,json:OM_JSON,inspect:OM_INSPECT,compact:OM_COMPACT};function getVersion(){return VERSION}function objCopy(a){var b;return Array.isArray(a)?b=a.slice():'object'===('undefined'==typeof a?'undefined':_typeof(a))?(b={},Object.keys(a).forEach(function(c){b[c]=a[c]})):b=a,b}if(util.format)format=util.format;else var _format=function(a){var b;if('string'!=typeof a){var c=[];for(b=0;b<arguments.length;b++)c.push(util.inspect(arguments[b]));return c.join(' ')}b=1;for(var g=arguments,h=g.length,i=(a+'').replace(formatRegExp,function(a){return b>=h?a:'%s'===a?g[b++]+'':'%d'===a?+g[b++]:'%j'===a?JSON.stringify(g[b++]):'%%'===a?'%':a}),j=g[b];b<h;j=g[++b])i+=null===j||'object'!==('undefined'==typeof j?'undefined':_typeof(j))?' '+j:' '+util.inspect(j);return str},formatRegExp=/%[sdj%]/g;function _parseString(a){var b='"'+a.replace(/\\"/,'"').replace('"','\\"')+'"';return eval(b)}var json_parse=function(){'use strict';var n,o,p,b,k={'"':'"',"\\":'\\',"/":'/',b:'\b',f:'\f',n:'\n',r:'\r',t:'\t'},q=function(c){throw{name:'SyntaxError',message:c,at:n,text:p}},r=function(a){return a&&a!==o&&q('Expected \''+a+'\' instead of \''+o+'\''),o=p.charAt(n),n+=1,o},c=function(){var b,a='';for('-'===o&&(a='-',r('-'));'0'<=o&&'9'>=o;)a+=o,r();if('.'===o)for(a+='.';r()&&'0'<=o&&'9'>=o;)a+=o;if('e'===o||'E'===o)for(a+=o,r(),('-'===o||'+'===o)&&(a+=o,r());'0'<=o&&'9'>=o;)a+=o,r();return b=+a,isFinite(b)?b:void q('Bad number')},f=function(){var b,a,c,f='';if('"'===o)for(;r();){if('"'===o)return r(),f;if('\\'!==o)f+=o;else if(r(),'u'===o){for(c=0,a=0;4>a&&(b=parseInt(r(),16),!!isFinite(b));a+=1)c=16*c+b;f+=String.fromCharCode(c)}else if('string'==typeof k[o])f+=k[o];else break}q('Bad string')},h=function(){for(;o&&' '>=o;)r()},g=function(){switch(o){case't':return r('t'),r('r'),r('u'),r('e'),!0;case'f':return r('f'),r('a'),r('l'),r('s'),r('e'),!1;case'n':return r('n'),r('u'),r('l'),r('l'),null;}q('Unexpected \''+o+'\'')},i=function(){var c=[];if('['===o){if(r('['),h(),']'===o)return r(']'),c;for(;o;){if(c.push(b()),h(),']'===o)return r(']'),c;r(','),h()}}q('Bad array')},j=function(){var g,a={};if('{'===o){if(r('{'),h(),'}'===o)return r('}'),a;for(;o;){if(g=f(),h(),r(':'),Object.hasOwnProperty.call(a,g)&&q('Duplicate key "'+g+'"'),a[g]=b(),h(),'}'===o)return r('}'),a;r(','),h()}}q('Bad object')};return b=function(){return h(),'{'===o?j():'['===o?i():'"'===o?f():'-'===o?c():'0'<=o&&'9'>=o?c():g()},function(a,i){var c;return p=a,n=0,o=' ',c=b(),h(),o&&q('Syntax error'),'function'==typeof i?function f(g,a){var b,c,h=g[a];if(h&&'object'==('undefined'==typeof h?'undefined':_typeof(h)))for(b in h)Object.prototype.hasOwnProperty.call(h,b)&&(c=f(h,b),void 0===c?delete h[b]:h[b]=c);return i.call(g,a,h)}({"":c},''):c}}();function printHelp(){var a=console.log;a('Usage:'),a('  <something generating JSON on stdout> | json [OPTIONS] [LOOKUPS...]'),a('  json -f FILE [OPTIONS] [LOOKUPS...]'),a(''),a('Pipe in your JSON for pretty-printing, JSON validation, filtering, '),a('and modification. Supply one or more `LOOKUPS` to extract a '),a('subset of the JSON. HTTP header blocks are skipped by default.'),a('Roughly in order of processing, features are:'),a(''),a('Grouping:'),a('  Use "-g" or "--group" to group adjacent objects, separated by'),a('  by no space or a by a newline, or adjacent arrays, separate by'),a('  by a newline. This can be helpful for, e.g.: '),a('     $ cat *.json | json -g ... '),a('  and similar.'),a(''),a('Execution:'),a('  Use the "-e CODE" option to execute JavaScript code on the input JSON.'),a('     $ echo \'{"name":"trent","age":38}\' | json -e \'this.age++\''),a('     {'),a('       "name": "trent",'),a('       "age": 39'),a('     }'),a('  If input is an array, this will automatically process each'),a('  item separately.'),a(''),a('Conditional filtering:'),a('  Use the "-c CODE" option to filter the input JSON.'),a('     $ echo \'[{"age":38},{"age":4}]\' | json -c \'this.age>21\''),a('     [{\'age\':38}]'),a('  If input is an array, this will automatically process each'),a('  item separately. Note: "CODE" is JavaScript code.'),a(''),a('Lookups:'),a('  Use lookup arguments to extract particular values:'),a('     $ echo \'{"name":"trent","age":38}\' | json name'),a('     trent'),a(''),a('  Use "-a" for *array processing* of lookups and *tabular output*:'),a('     $ echo \'{"name":"trent","age":38}\' | json name age'),a('     trent'),a('     38'),a('     $ echo \'[{"name":"trent","age":38},'),a('               {"name":"ewan","age":4}]\' | json -a name age'),a('     trent 38'),a('     ewan 4'),a(''),a('In-place editing:'),a('  Use "-I, --in-place" to edit a file in place:'),a('     $ json -I -f config.json  # reformat'),a('     $ json -I -f config.json -c \'this.logLevel="debug"\' # add field'),a(''),a('Pretty-printing:'),a('  Output is "jsony" by default: 2-space indented JSON, except a'),a('  single string value is printed without quotes.'),a('     $ echo \'{"name": "trent", "age": 38}\' | json'),a('     {'),a('       "name": "trent",'),a('       "age": 38'),a('     }'),a('     $ echo \'{"name": "trent", "age": 38}\' | json name'),a('     trent'),a(''),a('  Use \'-j\' or \'-o json\' for explicit JSON, \'-o json-N\' for N-space indent:'),a('     $ echo \'{"name": "trent", "age": 38}\' | json -o json-0'),a('     {"name":"trent","age":38}'),a(''),a('Options:'),a('  -h, --help    Print this help info and exit.'),a('  --version     Print version of this command and exit.'),a('  -q, --quiet   Don\'t warn if input isn\'t valid JSON.'),a(''),a('  -f FILE       Path to a file to process. If not given, then'),a('                stdin is used.'),a('  -I, --in-place  In-place edit of the file given with "-f".'),a('                Lookups are not allow with in-place editing'),a('                because it makes it too easy to lose content.'),a(''),a('  -H            Drop any HTTP header block (as from `curl -i ...`).'),a('  -g, --group   Group adjacent objects or arrays into an array.'),a('  --merge       Merge adjacent objects into one. Keys in last '),a('                object win.'),a('  --deep-merge  Same as "--merge", but will recurse into objects '),a('                under the same key in both.'),a('  -a, --array   Process input as an array of separate inputs'),a('                and output in tabular form.'),a('  -A            Process input as a single object, i.e. stop'),a('                "-e" and "-c" automatically processing each'),a('                item of an input array.'),a('  -d DELIM      Delimiter char for tabular output (default is " ").'),a('  -D DELIM      Delimiter char between lookups (default is "."). E.g.:'),a('                    $ echo \'{"a.b": {"b": 1}}\' | json -D / a.b/b'),a(''),a('  -M, --items   Itemize an object into an array of '),a('                    {"key": <key>, "value": <value>}'),a('                objects for easier processing.'),a(''),a('  -e CODE       Execute the given JavaScript code on the input. If input'),a('                is an array, then each item of the array is processed'),a('                separately (use "-A" to override).'),a('  -c CODE       Filter the input with JavaScript `CODE`. If `CODE`'),a('                returns false-y, then the item is filtered out. If'),a('                input is an array, then each item of the array is '),a('                processed separately (use "-A" to override).'),a(''),a('  -k, --keys    Output the input object\'s keys.'),a('  -n, --validate  Just validate the input (no processing or output).'),a('                Use with "-q" for silent validation (exit status).'),a(''),a('  -o, --output MODE'),a('                Specify an output mode. One of:'),a('                    jsony (default): JSON with string quotes elided'),a('                    json: JSON output, 2-space indent'),a('                    json-N: JSON output, N-space indent, e.g. "json-4"'),a('                    inspect: node.js `util.inspect` output'),a('  -i            Shortcut for `-o inspect`'),a('  -j            Shortcut for `-o json`'),a('  -0, -2, -4    Set indentation to the given value w/o setting MODE.'),a('                    -0   =>  -o jsony-0'),a('                    -4   =>  -o jsony-4'),a('                    -j0  =>  -o json-0'),a(''),a('See <http://trentm.com/json> for more docs and '),a('<https://github.com/trentm/json> for project details.')}function parseArgv(a){for(var f=a.slice(2),g=[],h={d:!0,o:!0,D:!0},k=0;k<f.length;k++){if('--'===f[k]){g=g.concat(f.slice(k));break}if('-'===f[k].charAt(0)&&'-'!==f[k].charAt(1)&&2<f[k].length){for(var i=f[k].slice(1).split(''),l=0;l<i.length;l++)if(g.push('-'+i[l]),h[i[l]]){var j=i.slice(l+1).join('');j.length&&g.push(j);break}}else g.push(f[k])}for(args=newArgs,endOfOptions=!1;0<args.length;){var m=args.shift();if(endOfOptions){parsed.args.push(m);break}switch(m){case'--':endOfOptions=!0;break;case'-h':case'--help':parsed.help=!0;break;case'--version':parsed.version=!0;break;case'-q':case'--quiet':parsed.quiet=!0;break;case'-H':parsed.dropHeaders=!0;break;case'-o':case'--output':var b=args.shift();if(!b)throw new Error('no argument given for "-o|--output" option');var c=b.lastIndexOf('-');if(-1!==c){var n=b.slice(c+1);/^\d+$/.test(n)?(parsed.jsonIndent=+n,b=b.slice(0,c)):'tab'===n&&(parsed.jsonIndent='\t',b=b.slice(0,c))}if(parsed.outputMode=OM_FROM_NAME[b],void 0===parsed.outputMode)throw new Error('unknown output mode: "'+b+'"');break;case'-0':parsed.jsonIndent=0;break;case'-2':parsed.jsonIndent=2;break;case'-4':parsed.jsonIndent=4;break;case'-I':case'--in-place':parsed.inPlace=!0;break;case'-i':parsed.outputMode=OM_INSPECT;break;case'-j':parsed.outputMode=OM_JSON;break;case'-a':case'--array':parsed.array=!0;break;case'-A':parsed.array=!1;break;case'-d':parsed.delim=_parseString(args.shift());break;case'-D':if(parsed.lookupDelim=args.shift(),1!==parsed.lookupDelim.length)throw new Error(format('invalid lookup delim "%s" (must be a single char)',parsed.lookupDelim));break;case'-e':case'-E':parsed.exeSnippets.push(args.shift());break;case'-c':case'-C':parsed.condSnippets.push(args.shift());break;case'-M':case'--items':parsed.items=!0;break;case'-k':case'--keys':parsed.outputKeys=!0;break;case'-g':case'--group':parsed.group=!0;break;case'--merge':parsed.merge='shallow';break;case'--deep-merge':parsed.merge='deep';break;case'-f':parsed.inputFiles.push(args.shift());break;case'-n':case'--validate':parsed.validate=!0;break;default:if(!endOfOptions&&0<m.length&&'-'===m[0])throw new Error('unknown option "'+m+'"');parsed.args.push(m);}}if(parsed.group&&parsed.merge)throw new Error('cannot use -g|--group and --merge options together');if(parsed.outputKeys&&0<parsed.args.length)throw new Error('cannot use -k|--keys option and lookup arguments together');if(parsed.inPlace&&1!==parsed.inputFiles.length)throw new Error('must specify exactly one file with "-f FILE" to use -I/--in-place');if(parsed.inPlace&&0<parsed.args.length)throw new Error('lookups cannot be specified with in-place editing (-I/--in-place), too easy to lose content');return parsed}function chunkEmitter(a){function b(b){for(;;){if('HTTP/'===b.slice(0,5)){var c=b.indexOf('\r\n\r\n'),f=4;if(-1==c&&(c=b.indexOf('\n\n'),f=2),-1!=c){a.dropHeaders||emit(b.slice(0,c+f));var g='HTTP/1.1 100 Continue'===b.slice(0,21);if(b=b.slice(c+f),g)continue;l=!0}}else l=!0;break}return b}function c(a,b){var c=/(})(\s*\n\s*)?({\s*")/,f=a.trimLeft();if(f&&'{'!==f[0])return h=!1,j.push(a),'';var g=a.split(c);if(1===g.length){var m=a.split(/\s*\r?\n/)[0];if('}'===m[m.length-1]){var n;try{n=JSON.parse(a)}catch(a){}n!==void 0&&(b.emit('chunk',a,n),a='')}return a}var k,l=g.length-2;k=g[0]+g[1],b.emit('chunk',k,JSON.parse(k));for(var o=3;o<l;o+=4)k=g[o]+g[o+1]+g[o+2],b.emit('chunk',k,JSON.parse(k));return g[l]+g[l+1]}function f(a){a.on('data',function(a){var f=k+a;if(l||(f=b(f)),!l)k=f;else{if(!h)return void j.push(a);k=c(f,g)}})}var g=new EventEmitter,h=!0,j=[],k='',l=!1;if(0<a.inputFiles.length){var m=function(b){b.on('error',function(){g.emit('error',format('could not read "%s": %s',a.inputFiles[o],e))})},n=function(b){b.on('end',function(){if(o<a.inputFiles.length){var b=a.inputFiles[o++],i=fs.createReadStream(b,{encoding:'utf8'});m(i),n(i),f(i)}else h?k&&(k=c(k,g),g.emit('chunk',k)):g.emit('chunk',j.join('')),g.emit('end')})},o=0,i=fs.createReadStream(a.inputFiles[o++],{encoding:'utf8'});m(i),n(i),f(i)}else{var p=process.openStdin();p.setEncoding('utf8'),f(p),p.on('end',function(){h?k&&(k=c(k,g),g.emit('chunk',k)):g.emit('chunk',j.join('')),g.emit('end')})}return g}function getInput(a,b){if(0===a.inputFiles.length){var c=[],f=process.openStdin();f.setEncoding('utf8'),f.on('data',function(a){c.push(a)}),f.on('end',function(){b(null,c.join(''))})}else if(a.inPlace)for(var g=0;g<a.inputFiles.length;g++){var h,i=a.inputFiles[g];try{h=fs.readFileSync(i,'utf8')}catch(a){b(a,null,i)}h&&b(null,h,i)}else{var g=0,c=[];try{for(;g<a.inputFiles.length;g++)c.push(fs.readFileSync(a.inputFiles[g],'utf8'))}catch(c){return b(format('could not read "%s": %s',a.inputFiles[g],c))}b(null,c.join(''),1===a.inputFiles.length?a.inputFiles[0]:void 0)}}function isInteger(a){return 0==a.search(/^-?[0-9]+$/)}function parseLookup(a,b){var c=function(){},f=[];c('\n*** '+a+' ***'),f=[],b=b||'.';for(var g='',h=[null],j=!1,k=null,l=0;l<a.length;++l){var j=!j&&'\\'===k,k=a[l];if(c('-- i='+l+', ch='+JSON.stringify(k)+' escaped='+JSON.stringify(j)),c('states: '+JSON.stringify(h)),j){g+=k;continue}switch(h[h.length-1]){case null:'"'===k||'\''===k?(h.push(k),g+=k):'['===k?(h.push(k),''!==g&&(f.push(g),g=''),g+=k):k===b?''!==g&&(f.push(g),g=''):g+=k;break;case'[':switch(g+=k,k){case'"':case'\'':case'[':h.push(k);break;case']':if(h.pop(),null===h[h.length-1]){var m=vm.runInNewContext('('+g.slice(1,-1)+')',{},'<lookup>');f.push(m),g=''}}break;case'"':g+=k,'"'===k?(h.pop(),null===h[h.length-1]&&(f.push(g),g='')):void 0;break;case'\'':g+=k,'\''===k?(h.pop(),null===h[h.length-1]&&(f.push(g),g='')):void 0;}c('bit: '+JSON.stringify(g)),c('bits: '+JSON.stringify(f))}''!==g&&(f.push(g),g='');for(var i=/^-\d+$/,l=0;l<f.length;l++)i.test(f[l])&&(f[l]=+f[l]);return c(JSON.stringify(a)+' -> '+JSON.stringify(f)),f}function parseInput(a,b,c,f){if(b)return{datum:b};if(c){var g=a;[/(})\s*\n\s*({)/g,/(})({")/g].forEach(function(a){g=g.replace(a,'$1,\n$2')}),[/(\])\s*\n\s*(\[)/g].forEach(function(a){g=g.replace(a,',\n')}),g=g.trim(),'['!==g[0]&&(g='[\n'+g),']'!==g.slice(-1)&&(g+='\n]\n');try{return{datum:JSON.parse(g)}}catch(a){return{error:a}}}else if(f){var g,h,b,h,i=function(){g=a,[/(})\s*\n\s*({)/g,/(})({")/g].forEach(function(a){g=g.replace(a,'$1,\n$2')}),g='[\n'+g+'\n]\n';var c;try{c=JSON.parse(g)}catch(a){return{v:{error:a}}}var i=c[0];if('shallow'===f)for(h=1;h<c.length;h++)b=c[h],Object.keys(b).forEach(function(a){i[a]=b[a]});else if('deep'===f){var j=function(c,a){Object.keys(a).forEach(function(b){c[b]&&a[b]&&'[object Object]'===toString.call(c[b])&&'[object Object]'===toString.call(a[b])?j(c[b],a[b]):c[b]=a[b]})};for(h=1;h<c.length;h++)j(i,c[h])}else throw new Error(format('unknown value for "merge": "%s"',f));return{v:{datum:i}}}();if('object'===('undefined'==typeof i?'undefined':_typeof(i)))return i.v}else try{return{datum:JSON.parse(a)}}catch(a){return{error:a}}}function lookupDatum(a,b){for(var c,f=a,g=0;g<b.length;g++)if(c=b[g],f='number'==typeof c&&0>c?f[f.length+c]:f[c],void 0===f)return;return d}function printDatasets(a,b,c,g){var h=!b&&process.stdout.isTTY,j=emit;if(b){var k=path.resolve(path.dirname(b),format('.%s-json-%s-%s.tmp',path.basename(b),process.pid,Date.now())),l=fs.statSync(b),m=fs.createWriteStream(k,{encoding:'utf8',mode:l.mode});j=m.write.bind(m)}c&&0<c.length&&j(c);for(var f=0;f<a.length;f++){var i=a[f],n=stringifyDatum(i[0],g,h),o=i[1];n&&n.length?(j(n),j(o)):i[2]&&j(o)}b&&m.on('open',function(){m.end(),fs.renameSync(k,b),g.quiet||warn('json: updated "%s" in-place',b)})}function stringifyDatum(a,b,c){var f=null;switch(b.outputMode){case OM_INSPECT:f=util.inspect(a,!1,Infinity,c);break;case OM_JSON:'undefined'!=typeof a&&(f=JSON.stringify(a,null,b.jsonIndent));break;case OM_COMPACT:if(a===void 0);else if(Array.isArray(a)){var g=['[\n'];a.forEach(function(a){g.push('  '),g.push(JSON.stringify(a,null,0).replace(/,"(?![,:])/g,', "')),g.push(',\n')}),g.push(g.pop().slice(0,-2)+'\n'),g.push(']'),f=g.join('')}else f=JSON.stringify(a,null,0);break;case OM_JSONY:'string'==typeof a?f=a:'undefined'!=typeof a&&(f=JSON.stringify(a,null,b.jsonIndent));break;default:throw new Error('unknown output mode: '+b.outputMode);}return f}function printDatum(a,b,c,f){var g=stringifyDatum(a,b);g&&g.length?(emit(g),emit(c)):f&&emit(c)}var stdoutFlushed=!0;function emit(a){if(!drainingStdout)try{stdoutFlushed=process.stdout.write(a)}catch(a){}}process.stdout.on('error',function(a){'EPIPE'===a.code?drainStdoutAndExit(0):(warn(a),drainStdoutAndExit(1))});var drainingStdout=!1;function drainStdoutAndExit(a){drainingStdout||(drainingStdout=!0,process.stdout.on('drain',function(){process.exit(a)}),process.stdout.on('close',function(){process.exit(a)}),stdoutFlushed&&process.exit(a))}function funcWithReturnFromSnippet(a){return-1===a.indexOf('return')&&(';'===a.substring(a.length-1)&&(a=a.substring(0,a.length-1)),a='return ('+a+')'),new Function(a)}function main(a){function b(a,b,f,g,h){if(a.length){var q=parseInput(a,b,c.group,c.merge);if(q.error){if(!c.quiet){var E='',F=a.replace(/\r\n|\n|\r/,'\n');try{json_parse(F),E=q.error}catch(b){var G,H,I=b.at-1,J=a.split('\n'),K=0;for(G=0;G<J.length;G++)if(K+=J[G].length+1,K>I){H=I-(K-J[G].length-1);break}for(var r='',s=0;s<H;s++)r+='.';E=b.message+' at line '+(G+1)+', column '+(H+1)+':\n        '+J[G]+'\n        '+r+'^'}warn('json: error: %s is not JSON: %s',f?'"'+f+'"':'input',E)}return c.validate||(emit(a),a.length&&'\n'!==a[a.length-1]&&emit('\n')),drainStdoutAndExit(1)}if(c.validate)return drainStdoutAndExit(0);var t=q.datum;if(c.items&&!Array.isArray(t)){var L,M=[];for(L in t)t.hasOwnProperty(L)&&M.push({key:L,value:t[L]});t=M}var s,u;if(!o);else if(c.array||null===c.array&&Array.isArray(t)){var j=!1;for(Array.isArray(t)||(j=!0,t=[t]),s=0;s<t.length;s++){var v=t[s];for(u=0;u<m.length;u++)m[u].call(v);for(u=0;u<n.length;u++)n[u].runInNewContext(v)}j&&(t=t[0])}else{for(u=0;u<m.length;u++)m[u].call(t);for(u=0;u<n.length;u++)n[u].runInNewContext(t)}if(!l);else if(c.array||null===c.array&&Array.isArray(t)){var j=!1;Array.isArray(t)||(j=!0,t=[t]);var N=[];for(s=0;s<t.length;s++){var v=t[s],w=objCopy(v),x=!0;for(u=0;u<i.length;u++)if(!i[u].call(w)){x=!1;break}if(x){for(u=0;u<k.length;u++)if(!k[u].runInNewContext(w)){x=!1;break}x&&N.push(v)}}t=j?N.length?N[0]:[]:N}else{var x=!0,y=objCopy(t);for(u=0;u<i.length;u++)if(!i[u].call(y)){x=!1;break}if(x)for(u=0;u<k.length;u++)if(!k[u].runInNewContext(y)){x=!1;break}x||(t=void 0)}var z=!1;if(p.length)if(c.array){Array.isArray(t)||(t=[t]);var O=[];for(u=0;u<t.length;u++){var v=t[u],A={};for(s=0;s<p.length;s++){var B=p[s],C=lookupDatum(v,B);void 0!==C&&(A[B.join('.')]=C)}O.push(A)}t=O}else{if(Array.isArray(t))for(z=!0,s=0;s<p.length;s++)if(1!==p[s].length||isNaN(+p[s])){z=!1;break}var A={};for(s=0;s<p.length;s++){var B=p[s],C=lookupDatum(t,B);void 0!==C&&(A[B.join('.')]=C)}t=A}if(c.outputKeys)var t=Object.keys(t);var D=[];if(c.outputMode===OM_JSON){if(1===p.length&&!c.array)t=t[p[0].join('.')];else if(z){var P=[];for(s=0;s<p.length;s++){var Q=p[s].join('.');t.hasOwnProperty(Q)&&P.push(t[Q])}t=P}D.push([t,'\n',!1])}else if(p.length){if(c.array)for(u=0;u<t.length;u++){var A=t[u];for(s=0;s<p.length-1;s++)D.push([A[p[s].join('.')],c.delim,!0]);D.push([A[p[s].join('.')],'\n',!0])}else for(s=0;s<p.length;s++)D.push([t[p[s].join('.')],'\n',!1]);}else if(c.array)for(Array.isArray(t)||(t=[t]),u=0;u<t.length;u++)D.push([t[u],'\n',!1]);else D.push([t,'\n',!1]);printDatasets(D,g?f:void 0,h,c)}}var c;try{c=parseArgv(a)}catch(a){return warn('json: error: %s',a.message),drainStdoutAndExit(1)}if(c.help)return void printHelp();if(c.version){if(c.outputMode===OM_JSON){var j={version:getVersion(),author:'Trent Mick',project:'https://github.com/trentm/json'};console.log(JSON.stringify(j,null,c.jsonIndent))}else console.log('json '+getVersion()),console.log('written by Trent Mick'),console.log('https://github.com/trentm/json');return}var f,g=c.args,h=!!(process.env.JSON_EXEC&&'vm'===process.env.JSON_EXEC),i=[];if(!h)for(f=0;f<c.condSnippets.length;f++)i[f]=funcWithReturnFromSnippet(c.condSnippets[f]);var k=[];if(h)for(f=0;f<c.condSnippets.length;f++)k[f]=vm.createScript(c.condSnippets[f]);var l=!!(i.length+k.length),m=[];if(!h)for(f=0;f<c.exeSnippets.length;f++)m[f]=new Function(c.exeSnippets[f]);var n=[];if(h)for(f=0;f<c.exeSnippets.length;f++)n[f]=vm.createScript(c.exeSnippets[f]);var o=!!(m.length+n.length),p=g.map(function(a){return parseLookup(a,c.lookupDelim)});if(c.group&&c.array&&c.outputMode!==OM_JSON){var q=chunkEmitter(c);q.on('error',function(){return warn('json: error: %s',err),drainStdoutAndExit(1)}),q.on('chunk',b)}else c.inPlace?(assert.equal(c.inputFiles.length,1,'cannot handle more than one file with -I'),getInput(c,function(a,f,g){if(a)return warn('json: error: %s',a),drainStdoutAndExit(1);for(var h=[];;){if('HTTP/'===f.slice(0,5)){var i=f.indexOf('\r\n\r\n'),j=4;if(-1==i&&(i=f.indexOf('\n\n'),j=2),-1!=i){c.dropHeaders||h.push(f.slice(0,i+j));var k='HTTP/1.1 100 Continue'===f.slice(0,21);if(f=f.slice(i+j),k)continue}}break}b(f,void 0,g,!0,headers.join(''))})):getInput(c,function(a,f,g){if(a)return warn('json: error: %s',a),drainStdoutAndExit(1);for(;;){if('HTTP/'===f.slice(0,5)){var h=f.indexOf('\r\n\r\n'),i=4;if(-1==h&&(h=f.indexOf('\n\n'),i=2),-1!=h){c.dropHeaders||emit(f.slice(0,h+i));var j='HTTP/1.1 100 Continue'===f.slice(0,21);if(f=f.slice(h+i),j)continue}}break}b(f,null,g,!1)})}if(require.main===module){var nodeVer=process.versions.node.split('.').map(Number);if([0,6,0]<=nodeVer&&[0,6,8]>=nodeVer){var stdout=process.stdout;stdout.end=stdout.destroy=stdout.destroySoon=function(){}}main(process.argv)}