#!/usr/bin/env node
'use strict';const VERSION='9.0.4',p=console.warn,util=require('util'),assert=require('assert'),path=require('path'),vm=require('vm'),fs=require('fs'),warn=console.warn,EventEmitter=require('events').EventEmitter;exports.main=main,exports.getVersion=getVersion,exports.parseLookup=parseLookup,exports.lookupDatum=lookupDatum,exports.printDatum=printDatum;const OM_JSONY=1,OM_JSON=2,OM_INSPECT=3,OM_COMPACT=4,OM_FROM_NAME={jsony:OM_JSONY,json:OM_JSON,inspect:OM_INSPECT,compact:OM_COMPACT};function getVersion(){return VERSION}function objCopy(a){let b;return Array.isArray(a)?b=a.slice():'object'==typeof a?(b={},Object.keys(a).forEach(function(c){b[c]=a[c]})):b=a,b}if(util.format)format=util.format;else{const a=/%[sdj%]/g}function _parseString(a){const b=`"${a.replace(/\\"/,'"').replace('"','\\"')}"`;return eval(b)}const json_parse=function(){'use strict';let n,o,p,b,k={'"':'"',"\\":'\\',"/":'/',b:'\b',f:'\f',n:'\n',r:'\r',t:'\t'},q=function(c){throw{name:'SyntaxError',message:c,at:n,text:p}},r=function(a){return a&&a!==o&&q(`Expected '${a}' instead of '${o}'`),o=p.charAt(n),n+=1,o},c=function(){let b,a='';for('-'===o&&(a='-',r('-'));'0'<=o&&'9'>=o;)a+=o,r();if('.'===o)for(a+='.';r()&&'0'<=o&&'9'>=o;)a+=o;if('e'===o||'E'===o)for(a+=o,r(),('-'===o||'+'===o)&&(a+=o,r());'0'<=o&&'9'>=o;)a+=o,r();return b=+a,isFinite(b)?b:void q('Bad number')},f=function(){let b,a,c,d='';if('"'===o)for(;r();){if('"'===o)return r(),d;if('\\'!==o)d+=o;else if(r(),'u'===o){for(c=0,a=0;4>a&&(b=parseInt(r(),16),!!isFinite(b));a+=1)c=16*c+b;d+=String.fromCharCode(c)}else if('string'==typeof k[o])d+=k[o];else break}q('Bad string')},h=function(){for(;o&&' '>=o;)r()},g=function(){switch(o){case't':return r('t'),r('r'),r('u'),r('e'),!0;case'f':return r('f'),r('a'),r('l'),r('s'),r('e'),!1;case'n':return r('n'),r('u'),r('l'),r('l'),null;}q(`Unexpected '${o}'`)},i=function(){const c=[];if('['===o){if(r('['),h(),']'===o)return r(']'),c;for(;o;){if(c.push(b()),h(),']'===o)return r(']'),c;r(','),h()}}q('Bad array')},j=function(){let d,a={};if('{'===o){if(r('{'),h(),'}'===o)return r('}'),a;for(;o;){if(d=f(),h(),r(':'),Object.hasOwnProperty.call(a,d)&&q(`Duplicate key "${d}"`),a[d]=b(),h(),'}'===o)return r('}'),a;r(','),h()}}q('Bad object')};return b=function(){return h(),'{'===o?j():'['===o?i():'"'===o?f():'-'===o?c():'0'<=o&&'9'>=o?c():g()},function(a,i){let c;return p=a,n=0,o=' ',c=b(),h(),o&&q('Syntax error'),'function'==typeof i?function f(g,a){let b,c,d=g[a];if(d&&'object'==typeof d)for(b in d)Object.prototype.hasOwnProperty.call(d,b)&&(c=f(d,b),void 0===c?delete d[b]:d[b]=c);return i.call(g,a,d)}({"":c},''):c}}();function printHelp(){const a=console.log;a('Usage:'),a('  <something generating JSON on stdout> | json [OPTIONS] [LOOKUPS...]'),a('  json -f FILE [OPTIONS] [LOOKUPS...]'),a(''),a('Pipe in your JSON for pretty-printing, JSON validation, filtering, '),a('and modification. Supply one or more `LOOKUPS` to extract a '),a('subset of the JSON. HTTP header blocks are skipped by default.'),a('Roughly in order of processing, features are:'),a(''),a('Grouping:'),a('  Use "-g" or "--group" to group adjacent objects, separated by'),a('  by no space or a by a newline, or adjacent arrays, separate by'),a('  by a newline. This can be helpful for, e.g.: '),a('     $ cat *.json | json -g ... '),a('  and similar.'),a(''),a('Execution:'),a('  Use the "-e CODE" option to execute JavaScript code on the input JSON.'),a('     $ echo \'{"name":"trent","age":38}\' | json -e \'this.age++\''),a('     {'),a('       "name": "trent",'),a('       "age": 39'),a('     }'),a('  If input is an array, this will automatically process each'),a('  item separately.'),a(''),a('Conditional filtering:'),a('  Use the "-c CODE" option to filter the input JSON.'),a('     $ echo \'[{"age":38},{"age":4}]\' | json -c \'this.age>21\''),a('     [{\'age\':38}]'),a('  If input is an array, this will automatically process each'),a('  item separately. Note: "CODE" is JavaScript code.'),a(''),a('Lookups:'),a('  Use lookup arguments to extract particular values:'),a('     $ echo \'{"name":"trent","age":38}\' | json name'),a('     trent'),a(''),a('  Use "-a" for *array processing* of lookups and *tabular output*:'),a('     $ echo \'{"name":"trent","age":38}\' | json name age'),a('     trent'),a('     38'),a('     $ echo \'[{"name":"trent","age":38},'),a('               {"name":"ewan","age":4}]\' | json -a name age'),a('     trent 38'),a('     ewan 4'),a(''),a('In-place editing:'),a('  Use "-I, --in-place" to edit a file in place:'),a('     $ json -I -f config.json  # reformat'),a('     $ json -I -f config.json -c \'this.logLevel="debug"\' # add field'),a(''),a('Pretty-printing:'),a('  Output is "jsony" by default: 2-space indented JSON, except a'),a('  single string value is printed without quotes.'),a('     $ echo \'{"name": "trent", "age": 38}\' | json'),a('     {'),a('       "name": "trent",'),a('       "age": 38'),a('     }'),a('     $ echo \'{"name": "trent", "age": 38}\' | json name'),a('     trent'),a(''),a('  Use \'-j\' or \'-o json\' for explicit JSON, \'-o json-N\' for N-space indent:'),a('     $ echo \'{"name": "trent", "age": 38}\' | json -o json-0'),a('     {"name":"trent","age":38}'),a(''),a('Options:'),a('  -h, --help    Print this help info and exit.'),a('  --version     Print version of this command and exit.'),a('  -q, --quiet   Don\'t warn if input isn\'t valid JSON.'),a(''),a('  -f FILE       Path to a file to process. If not given, then'),a('                stdin is used.'),a('  -I, --in-place  In-place edit of the file given with "-f".'),a('                Lookups are not allow with in-place editing'),a('                because it makes it too easy to lose content.'),a(''),a('  -H            Drop any HTTP header block (as from `curl -i ...`).'),a('  -g, --group   Group adjacent objects or arrays into an array.'),a('  --merge       Merge adjacent objects into one. Keys in last '),a('                object win.'),a('  --deep-merge  Same as "--merge", but will recurse into objects '),a('                under the same key in both.'),a('  -a, --array   Process input as an array of separate inputs'),a('                and output in tabular form.'),a('  -A            Process input as a single object, i.e. stop'),a('                "-e" and "-c" automatically processing each'),a('                item of an input array.'),a('  -d DELIM      Delimiter char for tabular output (default is " ").'),a('  -D DELIM      Delimiter char between lookups (default is "."). E.g.:'),a('                    $ echo \'{"a.b": {"b": 1}}\' | json -D / a.b/b'),a(''),a('  -M, --items   Itemize an object into an array of '),a('                    {"key": <key>, "value": <value>}'),a('                objects for easier processing.'),a(''),a('  -e CODE       Execute the given JavaScript code on the input. If input'),a('                is an array, then each item of the array is processed'),a('                separately (use "-A" to override).'),a('  -c CODE       Filter the input with JavaScript `CODE`. If `CODE`'),a('                returns false-y, then the item is filtered out. If'),a('                input is an array, then each item of the array is '),a('                processed separately (use "-A" to override).'),a(''),a('  -k, --keys    Output the input object\'s keys.'),a('  -n, --validate  Just validate the input (no processing or output).'),a('                Use with "-q" for silent validation (exit status).'),a(''),a('  -o, --output MODE'),a('                Specify an output mode. One of:'),a('                    jsony (default): JSON with string quotes elided'),a('                    json: JSON output, 2-space indent'),a('                    json-N: JSON output, N-space indent, e.g. "json-4"'),a('                    inspect: node.js `util.inspect` output'),a('  -i            Shortcut for `-o inspect`'),a('  -j            Shortcut for `-o json`'),a('  -0, -2, -4    Set indentation to the given value w/o setting MODE.'),a('                    -0   =>  -o jsony-0'),a('                    -4   =>  -o jsony-4'),a('                    -j0  =>  -o json-0'),a(''),a('See <http://trentm.com/json> for more docs and '),a('<https://github.com/trentm/json> for project details.')}function parseArgv(a){const b={args:[],help:!1,quiet:!1,dropHeaders:!1,exeSnippets:[],condSnippets:[],outputMode:OM_JSONY,jsonIndent:2,array:null,delim:' ',lookupDelim:'.',items:!1,outputKeys:!1,group:!1,merge:null,inputFiles:[],validate:!1,inPlace:!1};let c=a.slice(2),d=[];const f={d:!0,o:!0,D:!0};for(let b=0;b<c.length;b++){if('--'===c[b]){d=d.concat(c.slice(b));break}if('-'===c[b].charAt(0)&&'-'!==c[b].charAt(1)&&2<c[b].length){const a=c[b].slice(1).split('');for(let b=0;b<a.length;b++)if(d.push(`-${a[b]}`),f[a[b]]){const c=a.slice(b+1).join('');c.length&&d.push(c);break}}else d.push(c[b])}for(c=d,endOfOptions=!1;0<c.length;){const a=c.shift();if(endOfOptions){b.args.push(a);break}switch(a){case'--':endOfOptions=!0;break;case'-h':case'--help':b.help=!0;break;case'--version':b.version=!0;break;case'-q':case'--quiet':b.quiet=!0;break;case'-H':b.dropHeaders=!0;break;case'-o':case'--output':var g=c.shift();if(!g)throw new Error('no argument given for "-o|--output" option');var h=g.lastIndexOf('-');if(-1!==h){const a=g.slice(h+1);/^\d+$/.test(a)?(b.jsonIndent=+a,g=g.slice(0,h)):'tab'===a&&(b.jsonIndent='\t',g=g.slice(0,h))}if(b.outputMode=OM_FROM_NAME[g],void 0===b.outputMode)throw new Error(`unknown output mode: "${g}"`);break;case'-0':b.jsonIndent=0;break;case'-2':b.jsonIndent=2;break;case'-4':b.jsonIndent=4;break;case'-I':case'--in-place':b.inPlace=!0;break;case'-i':b.outputMode=OM_INSPECT;break;case'-j':b.outputMode=OM_JSON;break;case'-a':case'--array':b.array=!0;break;case'-A':b.array=!1;break;case'-d':b.delim=_parseString(c.shift());break;case'-D':if(b.lookupDelim=c.shift(),1!==b.lookupDelim.length)throw new Error(format('invalid lookup delim "%s" (must be a single char)',b.lookupDelim));break;case'-e':case'-E':b.exeSnippets.push(c.shift());break;case'-c':case'-C':b.condSnippets.push(c.shift());break;case'-M':case'--items':b.items=!0;break;case'-k':case'--keys':b.outputKeys=!0;break;case'-g':case'--group':b.group=!0;break;case'--merge':b.merge='shallow';break;case'--deep-merge':b.merge='deep';break;case'-f':b.inputFiles.push(c.shift());break;case'-n':case'--validate':b.validate=!0;break;default:if(!endOfOptions&&0<a.length&&'-'===a[0])throw new Error(`unknown option "${a}"`);b.args.push(a);}}if(b.group&&b.merge)throw new Error('cannot use -g|--group and --merge options together');if(b.outputKeys&&0<b.args.length)throw new Error('cannot use -k|--keys option and lookup arguments together');if(b.inPlace&&1!==b.inputFiles.length)throw new Error('must specify exactly one file with "-f FILE" to use -I/--in-place');if(b.inPlace&&0<b.args.length)throw new Error('lookups cannot be specified with in-place editing (-I/--in-place), too easy to lose content');return b}function chunkEmitter(a){function b(b){for(;;){if('HTTP/'===b.slice(0,5)){let c=b.indexOf('\r\n\r\n'),d=4;if(-1==c&&(c=b.indexOf('\n\n'),d=2),-1!=c){a.dropHeaders||emit(b.slice(0,c+d));const f='HTTP/1.1 100 Continue'===b.slice(0,21);if(b=b.slice(c+d),f)continue;i=!0}}else i=!0;break}return b}function c(a,b){const c=/(})(\s*\n\s*)?({\s*")/,d=a.trimLeft();if(d&&'{'!==d[0])return g=!1,h.push(a),'';const f=a.split(c);if(1===f.length){const c=a.split(/\s*\r?\n/)[0];if('}'===c[c.length-1]){let c;try{c=JSON.parse(a)}catch(a){}c!==void 0&&(b.emit('chunk',a,c),a='')}return a}else{const a=f.length-2;let c;c=f[0]+f[1],b.emit('chunk',c,JSON.parse(c));for(let d=3;d<a;d+=4)c=f[d]+f[d+1]+f[d+2],b.emit('chunk',c,JSON.parse(c));return f[a]+f[a+1]}}function d(a){a.on('data',function(a){let d=j+a;if(i||(d=b(d)),!i)j=d;else{if(!g)return void h.push(a);j=c(d,f)}})}const f=new EventEmitter;let g=!0;const h=[];let j='',i=!1;if(0<a.inputFiles.length){function b(b){b.on('error',function(){f.emit('error',format('could not read "%s": %s',a.inputFiles[l],e))})}function k(i){i.on('end',function(){if(l<a.inputFiles.length){const c=a.inputFiles[l++],f=fs.createReadStream(c,{encoding:'utf8'});b(f),k(f),d(f)}else g?j&&(j=c(j,f),f.emit('chunk',j)):f.emit('chunk',h.join('')),f.emit('end')})}let l=0;const i=fs.createReadStream(a.inputFiles[l++],{encoding:'utf8'});b(i),k(i),d(i)}else{const a=process.openStdin();a.setEncoding('utf8'),d(a),a.on('end',function(){g?j&&(j=c(j,f),f.emit('chunk',j)):f.emit('chunk',h.join('')),f.emit('end')})}return f}function getInput(a,b){if(0===a.inputFiles.length){var c=[];const a=process.openStdin();a.setEncoding('utf8'),a.on('data',function(a){c.push(a)}),a.on('end',function(){b(null,c.join(''))})}else if(a.inPlace)for(var d=0;d<a.inputFiles.length;d++){const c=a.inputFiles[d];var f;try{f=fs.readFileSync(c,'utf8')}catch(a){b(a,null,c)}f&&b(null,f,c)}else{var d=0,c=[];try{for(;d<a.inputFiles.length;d++)c.push(fs.readFileSync(a.inputFiles[d],'utf8'))}catch(c){return b(format('could not read "%s": %s',a.inputFiles[d],c))}b(null,c.join(''),1===a.inputFiles.length?a.inputFiles[0]:void 0)}}function isInteger(a){return 0==a.search(/^-?[0-9]+$/)}function parseLookup(a,b){const c=function(){};let d=[];c(`\n*** ${a} ***`),d=[],b=b||'.';let f='';const g=[null];for(var h=!1,j=null,k=0;k<a.length;++k){var h=!h&&'\\'===j,j=a[k];if(c(`-- i=${k}, ch=${JSON.stringify(j)} escaped=${JSON.stringify(h)}`),c(`states: ${JSON.stringify(g)}`),h){f+=j;continue}switch(g[g.length-1]){case null:'"'===j||'\''===j?(g.push(j),f+=j):'['===j?(g.push(j),''!==f&&(d.push(f),f=''),f+=j):j===b?''!==f&&(d.push(f),f=''):f+=j;break;case'[':switch(f+=j,j){case'"':case'\'':case'[':g.push(j);break;case']':if(g.pop(),null===g[g.length-1]){const a=vm.runInNewContext(`(${f.slice(1,-1)})`,{},'<lookup>');d.push(a),f=''}}break;case'"':f+=j,'"'===j?(g.pop(),null===g[g.length-1]&&(d.push(f),f='')):void 0;break;case'\'':f+=j,'\''===j?(g.pop(),null===g[g.length-1]&&(d.push(f),f='')):void 0;}c(`bit: ${JSON.stringify(f)}`),c(`bits: ${JSON.stringify(d)}`)}''!==f&&(d.push(f),f='');const i=/^-\d+$/;for(var k=0;k<d.length;k++)i.test(d[k])&&(d[k]=+d[k]);return c(`${JSON.stringify(a)} -> ${JSON.stringify(d)}`),d}function parseInput(a,b,c,d){if(b)return{datum:b};if(c){var f=a;[/(})\s*\n\s*({)/g,/(})({")/g].forEach(function(a){f=f.replace(a,'$1,\n$2')}),[/(\])\s*\n\s*(\[)/g].forEach(function(a){f=f.replace(a,',\n')}),f=f.trim(),'['!==f[0]&&(f=`[\n${f}`),']'!==f.slice(-1)&&(f=`${f}\n]\n`);try{return{datum:JSON.parse(f)}}catch(a){return{error:a}}}else{if(d){var f=a;[/(})\s*\n\s*({)/g,/(})({")/g].forEach(function(a){f=f.replace(a,'$1,\n$2')}),f=`[\n${f}\n]\n`;let c;try{c=JSON.parse(f)}catch(a){return{error:a}}const h=c[0];if('shallow'===d)for(var b,g=1;g<c.length;g++)b=c[g],Object.keys(b).forEach(function(a){h[a]=b[a]});else if('deep'===d){function d(c,a){Object.keys(a).forEach(function(b){c[b]&&a[b]&&'[object Object]'===toString.call(c[b])&&'[object Object]'===toString.call(a[b])?d(c[b],a[b]):c[b]=a[b]})}for(var g=1;g<c.length;g++)d(h,c[g])}else throw new Error(format('unknown value for "merge": "%s"',d));return{datum:h}}try{return{datum:JSON.parse(a)}}catch(a){return{error:a}}}}function lookupDatum(a,b){let c=a;for(let d=0;d<b.length;d++){const a=b[d];if(c='number'==typeof a&&0>a?c[c.length+a]:c[a],void 0===c)return}return c}function printDatasets(a,b,c,d){const g=!b&&process.stdout.isTTY;let h=emit;if(b){var i=path.resolve(path.dirname(b),format('.%s-json-%s-%s.tmp',path.basename(b),process.pid,Date.now()));const a=fs.statSync(b);var j=fs.createWriteStream(i,{encoding:'utf8',mode:a.mode});h=j.write.bind(j)}c&&0<c.length&&h(c);for(let f=0;f<a.length;f++){const b=a[f],c=stringifyDatum(b[0],d,g),i=b[1];c&&c.length?(h(c),h(i)):b[2]&&h(i)}b&&j.on('open',function(){j.end(),fs.renameSync(i,b),d.quiet||warn('json: updated "%s" in-place',b)})}function stringifyDatum(a,b,c){let d=null;switch(b.outputMode){case OM_INSPECT:d=util.inspect(a,!1,Infinity,c);break;case OM_JSON:'undefined'!=typeof a&&(d=JSON.stringify(a,null,b.jsonIndent));break;case OM_COMPACT:if(a===void 0);else if(Array.isArray(a)){const b=['[\n'];a.forEach(function(a){b.push('  '),b.push(JSON.stringify(a,null,0).replace(/,"(?![,:])/g,', "')),b.push(',\n')}),b.push(`${b.pop().slice(0,-2)}\n`),b.push(']'),d=b.join('')}else d=JSON.stringify(a,null,0);break;case OM_JSONY:'string'==typeof a?d=a:'undefined'!=typeof a&&(d=JSON.stringify(a,null,b.jsonIndent));break;default:throw new Error(`unknown output mode: ${b.outputMode}`);}return d}function printDatum(a,b,c,d){const f=stringifyDatum(a,b);f&&f.length?(emit(f),emit(c)):d&&emit(c)}let stdoutFlushed=!0;function emit(a){if(!drainingStdout)try{stdoutFlushed=process.stdout.write(a)}catch(a){}}process.stdout.on('error',function(a){'EPIPE'===a.code?drainStdoutAndExit(0):(warn(a),drainStdoutAndExit(1))});var drainingStdout=!1;function drainStdoutAndExit(a){drainingStdout||(drainingStdout=!0,process.stdout.on('drain',function(){process.exit(a)}),process.stdout.on('close',function(){process.exit(a)}),stdoutFlushed&&process.exit(a))}function funcWithReturnFromSnippet(a){return-1===a.indexOf('return')&&(';'===a.substring(a.length-1)&&(a=a.substring(0,a.length-1)),a=`return (${a})`),new Function(a)}function main(a){function b(a,b,d,f,g){if(!a.length)return;const p=parseInput(a,b,c.group,c.merge);if(p.error){if(!c.quiet){let b='';const c=a.replace(/\r\n|\n|\r/,'\n');try{json_parse(c),b=p.error}catch(c){const d=c.at-1,f=a.split('\n');let g,h,i=0;for(g=0;g<f.length;g++)if(i+=f[g].length+1,i>d){h=d-(i-f[g].length-1);break}let j='';for(var q=0;q<h;q++)j+='.';b=`${c.message} at line ${g+1}, column ${h+1}:\n        ${f[g]}\n        ${j}^`}warn('json: error: %s is not JSON: %s',d?`"${d}"`:'input',b)}return c.validate||(emit(a),a.length&&'\n'!==a[a.length-1]&&emit('\n')),drainStdoutAndExit(1)}if(c.validate)return drainStdoutAndExit(0);var r=p.datum;if(c.items&&!Array.isArray(r)){const a=[];for(var s in r)r.hasOwnProperty(s)&&a.push({key:s,value:r[s]});r=a}var q,t;if(!n);else if(c.array||null===c.array&&Array.isArray(r)){var j=!1;for(Array.isArray(r)||(j=!0,r=[r]),q=0;q<r.length;q++){var u=r[q];for(t=0;t<l.length;t++)l[t].call(u);for(t=0;t<m.length;t++)m[t].runInNewContext(u)}j&&(r=r[0])}else{for(t=0;t<l.length;t++)l[t].call(r);for(t=0;t<m.length;t++)m[t].runInNewContext(r)}if(!k);else if(c.array||null===c.array&&Array.isArray(r)){var j=!1;Array.isArray(r)||(j=!0,r=[r]);const a=[];for(q=0;q<r.length;q++){var u=r[q];const b=objCopy(u);var v=!0;for(t=0;t<h.length;t++)if(!h[t].call(b)){v=!1;break}if(v){for(t=0;t<i.length;t++)if(!i[t].runInNewContext(b)){v=!1;break}v&&a.push(u)}}r=j?a.length?a[0]:[]:a}else{var v=!0;const a=objCopy(r);for(t=0;t<h.length;t++)if(!h[t].call(a)){v=!1;break}if(v)for(t=0;t<i.length;t++)if(!i[t].runInNewContext(a)){v=!1;break}v||(r=void 0)}let w=!1;if(o.length)if(c.array){Array.isArray(r)||(r=[r]);const a=[];for(t=0;t<r.length;t++){var u=r[t],x={};for(q=0;q<o.length;q++){var y=o[q],z=lookupDatum(u,y);void 0!==z&&(x[y.join('.')]=z)}a.push(x)}r=a}else{if(Array.isArray(r))for(w=!0,q=0;q<o.length;q++)if(1!==o[q].length||isNaN(+o[q])){w=!1;break}var x={};for(q=0;q<o.length;q++){var y=o[q],z=lookupDatum(r,y);void 0!==z&&(x[y.join('.')]=z)}r=x}if(c.outputKeys)var r=Object.keys(r);const A=[];if(c.outputMode===OM_JSON){if(1===o.length&&!c.array)r=r[o[0].join('.')];else if(w){const a=[];for(q=0;q<o.length;q++){const b=o[q].join('.');r.hasOwnProperty(b)&&a.push(r[b])}r=a}A.push([r,'\n',!1])}else if(o.length){if(c.array)for(t=0;t<r.length;t++){var x=r[t];for(q=0;q<o.length-1;q++)A.push([x[o[q].join('.')],c.delim,!0]);A.push([x[o[q].join('.')],'\n',!0])}else for(q=0;q<o.length;q++)A.push([r[o[q].join('.')],'\n',!1]);}else if(c.array)for(Array.isArray(r)||(r=[r]),t=0;t<r.length;t++)A.push([r[t],'\n',!1]);else A.push([r,'\n',!1]);printDatasets(A,f?d:void 0,g,c)}let c;try{c=parseArgv(a)}catch(a){return warn('json: error: %s',a.message),drainStdoutAndExit(1)}if(c.help)return void printHelp();if(c.version){if(c.outputMode===OM_JSON){const a={version:getVersion(),author:'Trent Mick',project:'https://github.com/trentm/json'};console.log(JSON.stringify(a,null,c.jsonIndent))}else console.log(`json ${getVersion()}`),console.log('written by Trent Mick'),console.log('https://github.com/trentm/json');return}const d=c.args,f=!!(process.env.JSON_EXEC&&'vm'===process.env.JSON_EXEC);let g;const h=[];if(!f)for(g=0;g<c.condSnippets.length;g++)h[g]=funcWithReturnFromSnippet(c.condSnippets[g]);const i=[];if(f)for(g=0;g<c.condSnippets.length;g++)i[g]=vm.createScript(c.condSnippets[g]);const k=!!(h.length+i.length),l=[];if(!f)for(g=0;g<c.exeSnippets.length;g++)l[g]=new Function(c.exeSnippets[g]);const m=[];if(f)for(g=0;g<c.exeSnippets.length;g++)m[g]=vm.createScript(c.exeSnippets[g]);const n=!!(l.length+m.length),o=d.map(function(a){return parseLookup(a,c.lookupDelim)});if(c.group&&c.array&&c.outputMode!==OM_JSON){const a=chunkEmitter(c);a.on('error',function(){return warn('json: error: %s',err),drainStdoutAndExit(1)}),a.on('chunk',b)}else c.inPlace?(assert.equal(c.inputFiles.length,1,'cannot handle more than one file with -I'),getInput(c,function(a,d,f){if(a)return warn('json: error: %s',a),drainStdoutAndExit(1);const g=[];for(;;){if('HTTP/'===d.slice(0,5)){let a=d.indexOf('\r\n\r\n'),b=4;if(-1==a&&(a=d.indexOf('\n\n'),b=2),-1!=a){c.dropHeaders||g.push(d.slice(0,a+b));const f='HTTP/1.1 100 Continue'===d.slice(0,21);if(d=d.slice(a+b),f)continue}}break}b(d,void 0,f,!0,g.join(''))})):getInput(c,function(a,d,f){if(a)return warn('json: error: %s',a),drainStdoutAndExit(1);for(;;){if('HTTP/'===d.slice(0,5)){let a=d.indexOf('\r\n\r\n'),b=4;if(-1==a&&(a=d.indexOf('\n\n'),b=2),-1!=a){c.dropHeaders||emit(d.slice(0,a+b));const f='HTTP/1.1 100 Continue'===d.slice(0,21);if(d=d.slice(a+b),f)continue}}break}b(d,null,f,!1)})}if(require.main===module){const a=process.versions.node.split('.').map(Number);if([0,6,0]<=a&&[0,6,8]>=a){const a=process.stdout;a.end=a.destroy=a.destroySoon=function(){}}main(process.argv)}