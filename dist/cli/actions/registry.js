'use strict';var cmd=require('fedtools-commands'),log=require('fedtools-logs'),config=require('fedtools-config'),waterfall=require('async/waterfall'),parallel=require('async/parallel'),_=require('lodash'),inquirer=require('inquirer'),common=require('../../common'),NA='N/A',DEFAULT_NPM_REGISTRY='http://registry.npmjs.org/',DEFAULT_YARN_REGISTRY='http://registry.yarnpkg.com';function getEnvProxyStatus(){return{http:process.env.HTTP_PROXY||NA,https:process.env.HTTPS_PROXY||NA,noProxy:process.env.no_proxy||NA}}function runCommand(a,b){var c=NA;cmd.run(a,{status:!1},function(a,d,e){return!a&&e&&(c=e.replace(/\n$/,'')),c&&'undefined'!==c&&'null'!==c||(c=NA),b(null,c)})}function displayStatus(a){var b,c,d,e,f,g,h,i,j,k=[];parallel([function(a){var b=common.getExistingNpmrcProfiles();return _.isEmpty(b)?a():(b.enabled&&(i=b.enabled),_.isEmpty(b.available)||(j=b.available.sort()),a())},function(a){h=getEnvProxyStatus(),a()},function(a){runCommand('npm config get registry',function(c,d){b=d,a(c)})},function(a){runCommand('npm config get proxy',function(b,c){d=c,a(b)})},function(a){runCommand('npm config get https-proxy',function(b,c){e=c,a(b)})},function(a){runCommand('yarn config get registry',function(b,d){c=d,a(b)})},function(a){runCommand('yarn config get proxy',function(b,c){f=c,a(b)})},function(a){runCommand('yarn config get https-proxy',function(b,c){g=c,a(b)})}],function(){return k.push(log.strToColor('yellow','Environment')),k.push('http proxy  : '+h.http),k.push('https proxy : '+h.https),h.noProxy.split(',').forEach(function(a,b){0===b?k.push('no_proxy    : '+a):k.push('              '+a)}),k.push(''),k.push(log.strToColor('yellow','NPM Configuration')),k.push('registry    : '+b),k.push('http proxy  : '+d),k.push('https proxy : '+e),k.push(''),k.push(log.strToColor('yellow','Yarn Configuration')),k.push('registry    : '+c),k.push('http proxy  : '+f),k.push('https proxy : '+g),(i||j)&&(k.push(''),k.push(log.strToColor('yellow','Envtools Registry Profile(s)')),!i&&(i=common.NA),k.push('Current profile    : '+i),k.push('Available profiles : '+j.join(', '))),log.printMessagesInBox(k),a(null,{npmRegistry:b,npmHttpProxy:d,npmHttpsProxy:e,yarnRegistry:c,yarnHttpProxy:f,yarnHttpsProxy:g,envProxies:h,currentNpmProfile:i,availableNpmProfiles:j})})}function updateRegistry(a,b){waterfall([function(b){cmd.run('npm config set registry '+a,{status:!1},function(){b(null)})},function(b){cmd.run('yarn config set registry '+a,{status:!1},function(){b(null)})}],function(){log.echo(),log.success('Registry set to '+a),b()})}function setRegistryProxies(a,b,c,d){var e=a?'set':'unset',f=a?['npm config set proxy '+b,'npm config set https-proxy '+c]:['npm config delete proxy','npm config delete https-proxy'],g=_.map(f,function(a){return function(b){cmd.run(a,{status:!0},function(){b(null)})}});waterfall(g,function(){log.echo(),log.success('Registry proxies have been '+e),d()})}module.exports=function(){var a,b,c=666;waterfall([function(a){displayStatus(function(c,d){b=d,a(c)})},function(b){a=config.getKey('envtoolsnpmregistries'),a&&a.length||(a=[DEFAULT_NPM_REGISTRY,DEFAULT_YARN_REGISTRY],config.setKey('envtoolsnpmregistries',a)),b()},function(a){return b&&!_.isEmpty(b.availableNpmProfiles)?void common.displayConfirmation('Do you want to activate an existing Profile?',function(d){return d?a():void common.displayListOfOptions('Please choose one of the following options:',b.availableNpmProfiles,function(b,d){return b?a(1):void common.switchToNpmrcProfile(d,function(b,d){return b?a():(log.success('\nProfile "'+d+'" activated!'),a(c))})})}):a()},function(a){common.displayConfirmation('Do you want to update the current registry?',function(b){return b?void waterfall([function(a){common.displayConfirmation('Do you want to save this configuration in a profile?',a)},function(a){common.displayPromptWithInput('Please type a profile name:',function(b,c){b||common.createNpmrcProfile(c,function(b){a(b)})})},function(a){log.success('\nProfile created and active'),a()}],function(){a(b)}):a(b)})},function(b){var c={type:'list',name:'registry',message:'Please choose one of the following options:'};c.choices=a.slice(),c.choices.push({name:'Enter a custom registry',value:'custom'}),inquirer.prompt(c).then(function(c){var d,e=new RegExp(/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(localhost)|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,}))\.?)(?::\d{2,5})?(?:[/?#]\S*)?$/i);return'custom'===c.registry?void inquirer.prompt({type:'input',name:'custom',message:'Type a custom registry (including protocol):',validate:function validate(a){return a?!!e.test(a)||'Please enter a valid URL...':'Registry URL cannot be empty...'}}).then(function(c){return d=c.custom.toLowerCase().trim(),a.push(d),config.setKey('envtoolsnpmregistries',_.uniqWith(a,_.isEqual)),b(null,d)}):(d=c.registry.toLowerCase().trim(),b(null,d))})},function(a,b){common.unsetActiveNpmrcProfile(),updateRegistry(a,b)},function(a){var c=b.envProxies.http||b.npmHttpProxy,d=b.envProxies.https||b.npmHttpsProxy;return c&&d&&c!==common.NA&&d!==common.NA?void common.displayConfirmation('Do you need to enable proxies for this registry?',function(b){return b?setRegistryProxies(!1,null,null,a):setRegistryProxies(!0,c,d,a)}):a()},function(a){common.displayConfirmation('Do you want to save this configuration in a profile?',a)},function(a){common.displayPromptWithInput('Please type a profile name:',function(b,c){b||common.createNpmrcProfile(c,function(b){a(b)})})},function(a){log.success('\nProfile created and active'),a()}],function(a){a&&a!==c&&log.echo('\nBye then!')})};