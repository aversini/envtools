"use strict";function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d("next",a)},function(a){d("throw",a)})}return d("next")})}}const http=require("http"),handler=require("serve-handler"),compression=require("compression");var _require=require("util");const promisify=_require.promisify,_=require("lodash/core"),log=require("fedtools-logs");var _require2=require("kleur");const cyan=_require2.cyan,green=_require2.green,grey=_require2.grey,yellow=_require2.yellow,fs=require("fs-extra"),portfinder=require("portfinder"),argv=require("yargs").help("info").boolean(["C","l","u"]).alias("c","cache").alias("C","cors").alias("l","logs").alias("p","port").alias("u","unzipped").argv,common=require("../../common"),DEFAULT_PORT=8080,DEFAULT_CACHE=0,DEFAULT_CORS=!1,DEFAULT_GZIP=!0,DEFAULT_LOGS=!1,DEFAULT_PUBLIC=process.cwd(),DEFAULT_HEADERS={"X-Powered-By":`${common.ENVTOOLS.NAME} ${common.ENVTOOLS.VERSION}`};module.exports=function(){const a=()=>{log.echo(),log.rainbow(`  Usage: ${yellow("envtools web")} ${grey("[option] [path]")}`),log.echo(),log.echo("  Path:"),log.rainbow(`${grey("    The path to serve files from (Default: current folder)")}`),log.echo(),log.echo("  Options:"),log.echo(),log.rainbow(`${yellow("    -c, --cache")} ${grey("    Time in milliseconds for caching files (Default: 0)")}`),log.rainbow(`${yellow("    -C, --cors")} ${grey("     Setup * CORS headers to allow requests from any origin (Default: disabled)")}`),log.rainbow(`${yellow("    -h, --help")} ${grey("     Output usage information")}`),log.rainbow(`${yellow("    -l, --logs")} ${grey("     Print http requests (Default: disabled)")}`),log.rainbow(`${yellow("    -p, --port <n>")} ${grey(" Port to listen on - Will try next available if already used (Default: 8080)")}`),log.rainbow(`${yellow("    -u, --unzipped")} ${grey(" Disable GZIP compression (Default: false)")}`)},b=()=>{const a={headers:DEFAULT_HEADERS,public:DEFAULT_PUBLIC};return a.port=_.isNumber(argv.port)?argv.port:DEFAULT_PORT,a.cache=_.isNumber(argv.cache)?argv.cache:DEFAULT_CACHE,a.cors=_.isBoolean(argv.cors)||DEFAULT_CORS,a.logs=_.isBoolean(argv.logs)||DEFAULT_LOGS,a.gzip=!_.isBoolean(argv.unzipped)||!argv.unzipped,argv._&&argv._[1]&&fs.pathExistsSync(argv._[1])&&(a.public=argv._[1]),a},c=(a)=>{const b=new Date;log.rainbow(`${grey("[ ")}${grey(b.toDateString())} ${grey(b.toLocaleTimeString())}${grey(" ]")} ${green(a.method)} ${cyan(a.url)}`)},d=(a)=>{let b=!1;const c=()=>{if(!b)return b=!0,a()};process.on("SIGINT",c),process.on("SIGTERM",c),process.on("exit",c)},e=(a)=>{const b=promisify(compression()),e=(()=>{var d=_asyncToGenerator(function*(d,e,f){return a.cors&&e.setHeader("Access-Control-Allow-Origin","*"),0===a.cache?e.setHeader("Cache-Control","max-age=0, no-cache, no-store, must-revalidate"):e.setHeader("Cache-Control",`max-age=${a.cache}`),a.gzip&&(yield b(d,e)),a.logs&&c(d,e,f),handler(d,e,a)});return function(){return d.apply(this,arguments)}})(),f=http.createServer(e);f.on("error",(a)=>{log(a),process.exit(1)}),portfinder.getPort({port:a.port},(b,c)=>{if(b)throw b;else c&&c!==a.port&&(log.error(`Port ${a.port} is not available...`),log.warning(`Using next available instead: ${c}`),log.echo());a.port=c,f.listen(a.port,"0.0.0.0",_asyncToGenerator(function*(){d(function(){return f.close()});const b=`http://localhost:${a.port}`,c=[];c.push("Simple web server is up and running.\n"),c.push("URL is now available here:"),c.push(log.strToColor("cyan",b)),c.push("\nHit CTRL-C to stop the server."),log.printMessagesInBox(c)}))})};_asyncToGenerator(function*(){argv.h||argv.help?a():(e(b()),d(function(){log.echo(),log.echo("Gracefully shutting down. Please wait..."),process.on("SIGINT",function(){log.echo("Force-closing all open sockets..."),process.exit(0)})}))})()};