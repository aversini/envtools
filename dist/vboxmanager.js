#!/usr/bin/env node
'use strict';var optimist,program,_=require('lodash'),log=require('fedtools-logs'),inquirer=require('inquirer'),vb=require('./vb'),START_COMMAND='start',STOP_COMMAND='stop',VirtualBoxManager=function(){VirtualBoxManager._instance||(VirtualBoxManager._instance=this),this.init()};VirtualBoxManager.prototype.name='VirtualBoxManager',VirtualBoxManager.prototype._validateCommand=function(a){return(_.isBoolean(a.start)||_.isBoolean(a.stop))&&(this.headless=!!_.isBoolean(a.headless)&&a.headless,this.qualifiedCommand=_.isBoolean(a.start)?START_COMMAND:STOP_COMMAND,!0)},VirtualBoxManager.prototype._runCommand=function(a,b){function c(c){var e=d.headless?' (headless mode)':'',f=d.qualifiedCommand===STOP_COMMAND?' was stopped':' was started';log.success('Virtual machine '+a+f+e),b(c)}var d=this;d.qualifiedCommand===START_COMMAND?vb.start(a,!d.headless,c):vb.stop(a,c)},VirtualBoxManager.prototype.init=function(){var a=20,b=[new inquirer.Separator('')],c=this;c.availableVms=[],vb.list(function(d,e){if(d)throw new Error(d);_.each(e,function(d){d.name.length>a&&(a=d.name.length),b.push(d),c.availableVms.push(d)}),b=_.sortBy(b,'name'),c.availableVms=_.sortBy(c.availableVms,'name'),optimist=require('optimist').usage(log.strToColor('cyan','Usage: ')+'vm --start|--stop --headless').describe(START_COMMAND,'start or resume a virtual machine').describe(STOP_COMMAND,'suspend a virtual machine').describe('headless','start the VM without the GUI'),program=optimist.argv,c._validateCommand(program)?(b=_.filter(c.availableVms,function(a){return c.qualifiedCommand===START_COMMAND&&!a.running||c.qualifiedCommand===STOP_COMMAND&&a.running}),0===b.length&&(log.echo(),c.qualifiedCommand===START_COMMAND?log.notice('All VMs are currently running, nothing to start...'):log.notice('All VMs are currently suspended, nothing to stop...'),log.echo(),process.exit(0)),inquirer.prompt([{type:'checkbox',message:'Select at least one virtual machine',name:'vms',choices:b,validate:function validate(a){return 1>a.length&&(log.echo('\n\nNo VM choosen, bye then...'),process.exit(0)),!0}}]).then(function(a){_.each(a.vms,function(a){c._runCommand(a,function(){})})})):(optimist.showHelp(),0<b.length&&(log.rainbow(log.strToColor('cyan','Available Virtual Machines:\n')),_.each(c.availableVms,function(b){var c=b.name,d=a-c.length;c='Vm: '+c+' '+Array(d+1).join('.'),log.echo(c+' Running: '+b.running)})),log.echo(),process.exit(0))})},function(){return VirtualBoxManager._instance||new VirtualBoxManager}();