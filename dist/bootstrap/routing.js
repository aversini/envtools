'use strict';const _=require('lodash'),path=require('path'),inquirer=require('inquirer'),log=require('fedtools-logs'),common=require('../common'),plugins=require('./plugins/index');function _buildOptions(a,b){function c(a){const b=a.restrictOs||[process.platform];_.each(a.type,function(c){0<=b.indexOf(process.platform)&&d[c].push(a)})}const d={};let e=0;d[common.TYPE_MANUAL]=[],d[common.TYPE_AUTO]=[],d[common.TYPE_EXTRA]=[],c({name:a.i18n.t('bootstrap.configureEnvtools'),short:'Configure Envtools',value:e++,type:[common.TYPE_AUTO,common.TYPE_MANUAL],fct:plugins.configureEnvtools}),c({name:a.i18n.t('bootstrap.setProxy'),short:'Proxy setup',value:e++,type:[common.TYPE_AUTO,common.TYPE_MANUAL],fct:plugins.bootstrapProxy}),c({name:a.i18n.t('bootstrap.setUsrLocal'),short:'Enable sudo-less',value:e++,type:[common.TYPE_AUTO,common.TYPE_MANUAL],fct:plugins.fixUsrLocal,restrictOs:['darwin','linux']}),c({name:a.i18n.t('bootstrap.setGitCfg'),short:'Configure git',value:e++,type:[common.TYPE_AUTO,common.TYPE_MANUAL],fct:plugins.bootstrapGitConfiguration}),c({name:a.i18n.t('bootstrap.setNPM'),short:'Configure node and npm',value:e++,type:[common.TYPE_AUTO,common.TYPE_MANUAL],fct:plugins.bootstrapNodeAndNpm}),c({name:a.i18n.t('bootstrap.setMaven'),short:'Install Maven',value:e++,type:[common.TYPE_AUTO,common.TYPE_MANUAL],fct:plugins.bootstrapMaven}),c({name:a.i18n.t('bootstrap.setAutoCheck'),short:'Automatically check version',value:e++,type:[common.TYPE_AUTO],fct:plugins.setAutoCheck}),c({name:a.i18n.t('bootstrap.installYarn'),short:'Install Yarn',value:e++,type:[common.TYPE_EXTRA],fct:plugins.installYarn,restrictOs:['darwin']}),c({name:a.i18n.t('bootstrap.setBrew'),short:'Install Homebrew',value:e++,type:[common.TYPE_EXTRA],fct:plugins.bootstrapHomebrew,restrictOs:['darwin']}),c({name:a.i18n.t('bootstrap.setRuby'),short:'Install Ruby',value:e++,type:[common.TYPE_EXTRA],fct:plugins.bootstrapRuby,restrictOs:['darwin']}),c({name:a.i18n.t('bootstrap.terminalProfile'),short:'Install Terminal Profile',value:e++,type:[common.TYPE_EXTRA],fct:plugins.terminalProfile,restrictOs:['darwin']}),c({name:a.i18n.t('bootstrap.installNVM'),short:'Install nvm',value:e++,type:[common.TYPE_EXTRA],fct:plugins.installNVM,restrictOs:['darwin','linux']}),c({name:a.i18n.t('bootstrap.setQuicklook'),short:'Install Quicklook',value:e++,type:[common.TYPE_EXTRA],fct:plugins.installQuickLookPlugins,restrictOs:['darwin']}),c({name:a.i18n.t('bootstrap.fixScreensaver'),short:'Fix screensaver',value:e++,type:[common.TYPE_EXTRA],fct:plugins.fixScreensaver,restrictOs:['darwin']}),c({name:a.i18n.t('bootstrap.setAtom'),short:'Configure Atom',value:e++,type:[common.TYPE_EXTRA],fct:plugins.bootstrapAtom}),c({name:a.i18n.t('bootstrap.enablePowerChime'),short:'Enable Power Chime',value:e++,type:[common.TYPE_EXTRA],fct:plugins.togglePowerChimeSound,restrictOs:['darwin']}),c({name:a.i18n.t('bootstrap.setSinopia'),short:'Enable/disable sinopia',value:e++,type:[common.TYPE_EXTRA],fct:plugins.bootstrapSinopia}),b(null,d)}function _displayOptions(a,b,c,d){const e={};let f;e[common.TYPE_AUTO]=[c.i18n.t('bootstrap.intro.auto'),c.i18n.t('bootstrap.intro.getOutAdvice1')],e[common.TYPE_MANUAL]=[c.i18n.t('bootstrap.intro.manual'),c.i18n.t('bootstrap.intro.getOutAdvice2')],e[common.TYPE_EXTRA]=[c.i18n.t('bootstrap.intro.extra'),c.i18n.t('bootstrap.intro.getOutAdvice3')],log.resetConsole(),log.echo(),log.printMessagesInBox(e[a],common.LOG_COLORS.DEFAULT_BOX),log.echo(),a===common.TYPE_AUTO?require('./routing-auto')(c,b,d):(b[a].unshift(new inquirer.Separator('')),f=[{pageSize:b[a].length+1,type:'list',name:'command',message:c.i18n.t('bootstrap.intro.msg1'),choices:b[a]}],inquirer.prompt(f).then(function(e){const f=_.find(b[a],function(a){return a.value===e.command});return f&&_.isFunction(f.fct)?void f.fct(c,function(a,b,c){(!a||a===common.USER_IGNORE)&&c&&(log.echo(),log.success(c),log.echo()),d(a)}):d(1)}))}exports.routeCLIRequest=function(a,b,c){const d=[];b.i18n.loadPhrases(path.resolve(__dirname,'..','..','data','i18n','bootstrap')),_buildOptions(b,function(e,f){if(e)throw new Error(e);b.restartShortcutHint=!0,_displayOptions(a,f,b,function(a){return a&&a===common.USER_INTERRUPT||!a&&b.auto&&0===b.actionsDone?(log.echo(),log.echo('Bye then...'),c()):a&&a===common.USER_IGNORE?(log.echo(),c()):a&&a===common.USER_WARNING?(log.echo(),c()):void((!a&&b.auto&&b.actionsDone||!b.auto)&&(log.echo(),d.push('To take changes into account, you may have to restart your session.'),process.env.ENVTOOLS_VERSION&&b.restartShortcutHint&&d.push(`${log.strToColor('cyan','Hint:')} type r + ENTER or just restart your terminal...`),log.printMessagesInBox(d,{color:common.LOG_COLORS.WARNING,align:{2:log.ALIGN.CENTER}})),log.echo(),c(a))})})};