'use strict';var fs=require('fs-extra'),waterfall=require('async/waterfall'),path=require('path'),inquirer=require('inquirer'),cmd=require('fedtools-commands'),utilities=require('fedtools-utilities'),gith=utilities.git,log=require('fedtools-logs'),backup=require('../../backup'),common=require('../../common'),DOT_PROFILE_COMMENT='### Added by Envtools (custom nvm loader)',NVM_VERSION='v0.33.2',NVM_DIR='nvm',NVM_DEST_DIR=path.join(common.RUNTIME_DIR,NVM_DIR),NVM_URL='https://github.com/creationix/nvm.git';module.exports=function(a,b){function c(a,b,c){backup(a),fs.ensureFileSync(a),b?utilities.appendLinesInFile({lines:d,file:a},function(a){c(a)}):utilities.removeLinesInFile({lines:d,file:a},function(a){c(a)})}var d=[DOT_PROFILE_COMMENT],e=!1,f=!1,g=!1,h=fs.existsSync(NVM_DEST_DIR);a.debug&&(e=!0),d.push('export NVM_DIR="'+NVM_DEST_DIR+'"'),d.push('[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"  # This loads nvm'),d.push('[[ -r $NVM_DIR/bash_completion ]] && . $NVM_DIR/bash_completion'),waterfall([function(a){var b={message:h?'About to update nvm, continue?':'About to install nvm, continue?',type:'confirm',name:'goForIt',default:!0};inquirer.prompt(b).then(function(b){f=!b.goForIt,a()})},function(a){return h&&!f?void cmd.run('npm config delete prefix',{status:!0},a):a()},function(a){return h&&!f?void gith.checkoutBranch({cwd:NVM_DEST_DIR,branch:NVM_VERSION,silent:!0},function(b,c){b&&c.stderr&&log.error(c.stderr),a(b)}):a()},function(a){return h||f?a():void gith.cloneGitRepository({cloneArgs:'--branch '+NVM_VERSION,name:NVM_DIR,cwd:common.RUNTIME_DIR,verbose:e,silent:!0,url:NVM_URL},function(b,c){b&&c.stderr&&log.error(c.stderr),a(b)})},function(b){var c=[{type:'list',name:'load',message:'Please choose one of the following options',when:function when(){return!a.auto},choices:[{name:'Automatically load nvm at each session',short:'Load nvm',value:common.ON},{name:'Do not load nvm automatically',short:'Do not load nvm',value:common.OFF}]}];return h||!f?void inquirer.prompt(c).then(function(a){g=a.load===common.ON,b()}):b()},function(a){c(common.DOT_PROFILE,g,a)},function(a){c(common.DOT_BASH_PROFILE,g,a)},function(a){var b=h?'updated to '+NVM_VERSION:'installed',c='\nNode Version Manager (nvm)';f||(log.success(c+' has been '+b),c='nvm'),(h||!f)&&(g?log.success(c+' will load automatically at each session'):log.notice(c+' will NOT load automatically')),f||log.echo('The location is: '+NVM_DEST_DIR),a()}],function(c){a.restartShortcutHint=!1,f&&!h&&(c=common.USER_INTERRUPT),b(c)})};