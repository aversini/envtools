'use strict';var _=require('lodash'),fs=require('fs-extra'),waterfall=require('async/waterfall'),inquirer=require('inquirer'),path=require('path'),log=require('fedtools-logs'),cmd=require('fedtools-commands'),node=require('./node'),backup=require('../../backup'),common=require('../../common');function _installConfiguration(a,b){var c,d,e=path.join(__dirname,'..','..','..','data','third','sinopia','config.yaml'),f=path.join(process.env.RUNTIME_DIR,'config.yaml');return fs.existsSync(f)?b(null,a):void fs.readFile(e,function(e,g){return e?b(null,a):(c=_.template(g.toString()),d=c({dir:process.env.RUNTIME_DIR}),d)?void fs.writeFile(f,d,function(){b(null,a)}):b(null,a)})}function _setupSinopia(a,b){waterfall([function(a){var b={type:'list',name:'sinopia',message:'Please choose one of the following options',choices:[{name:'Activate Sinopia',value:common.ON},{name:'Deactivate Sinopia',value:common.OFF}]};inquirer.prompt(b).then(function(b){a(null,b.sinopia)})},function(a,b){fs.writeFile(common.ENVTOOLS.SINOPIA_STATUS,a,function(){b(null,a)})},function(a,b){var c,d,e;backup(node.NPM_CONFIG),a===common.ON?(log.notice('Activating Sinopia...'),c='npm config set registry http://localhost:4873/',cmd.run(c,{status:!0},function(){c='npm config delete proxy',cmd.run(c,{status:!0},function(){log.echo(),log.notice('Please restart your session and Sinopia'),b(common.USER_IGNORE)})})):(log.notice('De-activating Sinopia...'),c='npm config set registry http://registry.npmjs.org/',cmd.run(c,{status:!0},function(){if(!(fs.existsSync(common.ENVTOOLS.PROXY_FILE)&&fs.existsSync(common.ENVTOOLS.PROXY_STATUS_FILE)))return b();return(e=fs.readFileSync(common.ENVTOOLS.PROXY_STATUS_FILE,'utf8'),d=fs.readFileSync(common.ENVTOOLS.PROXY_FILE,'utf8'),''!==d&&e&&e.replace(/\n$/,'')===common.ON)?void(c='npm config set proxy '+d,cmd.run(c,{status:!0},function(){c='npm config set https-proxy '+d,cmd.run(c,{status:!0},function(){b()})})):b()}))}],function(c){b(c,a)})}module.exports={installConfiguration:_installConfiguration,setupSinopia:_setupSinopia};