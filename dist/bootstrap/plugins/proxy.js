'use strict';const url=require('url'),fs=require('fs-extra'),waterfall=require('async/waterfall'),log=require('fedtools-logs'),inquirer=require('inquirer'),common=require('../../common');module.exports=function(a,b){function c(b){const c=[{type:'list',name:'protocol',message:'Select the proxy protocol:',choices:['http','https','other']},{type:'input',name:'protocol',message:'Type the protocol you want to use: ',when(a){return'other'===a.protocol},validate(a){return!!a||'Protocol cannot be empty...'},filter(a){return a.replace('://','')}},{type:'list',name:'port',message:'Select the proxy port:',choices:['8080','80',{value:'',name:'none'},'other']},{type:'input',name:'port',message:'Type the port you want to use (<enter> for none): ',when(a){return'other'===a.port}},{type:'input',name:'url',message:'Type the proxy URL: ',validate(a){return!!a||'URL cannot be empty...'}}];inquirer.prompt(c).then(function(c){const e=url.parse(c.url);let f=c.url,g=`${c.protocol}://`,h=''===c.port?null:`:${c.port}`;e&&e.protocol&&(e.protocol&&('http:'===e.protocol||'https:'===e.protocol)?(g=`${e.protocol}//`,e.port&&(h=`:${e.port}`),e.hostname&&(f=e.hostname)):f=f.split(':')[0]);const i=g+f+h;return i?(fs.writeFileSync(common.ENVTOOLS.PROXY_FILE,i),log.echo(),log.success(`proxy set to ${i}`),log.echo(),d.push('To take your proxy into account, you need to restart your session.'),process.env.ENVTOOLS_VERSION&&(d.push(''),d.push(`${log.strToColor('cyan','Hint #1:')} type r ENTER or just restart your terminal...`),d.push(`${log.strToColor('cyan','Hint #2:')} type pon ENTER to turn the proxy ON.`),d.push(`${log.strToColor('cyan','Hint #3:')} type poff ENTER to turn the proxy OFF.`)),a.auto&&fs.writeFileSync(common.ENVTOOLS.RESUME_AUTO,''),a.msg=d,b(common.USER_WARNING,a)):a.auto?b(null,a):b(common.USER_INTERRUPT,a)})}const d=[];let e,f='';return a.auto&&fs.existsSync(common.ENVTOOLS.PROXY_FILE)?b(null,a):void waterfall([function(b){return e=[{type:'confirm',name:'goForIt',message:'Do you need to setup a proxy?',default:!0}],a.auto?void inquirer.prompt(e).then(function(c){return a.actionsPending++,c.goForIt?(a.actionsDone++,b()):b(common.USER_INTERRUPT)}):b()},function(b){fs.existsSync(common.ENVTOOLS.PROXY_FILE)?(f=fs.readFileSync(common.ENVTOOLS.PROXY_FILE,'utf8'),f&&''!==f&&(e=[{type:'confirm',name:'change',message:'Proxy already set... Do you want to change it?',default:!1}]),inquirer.prompt(e).then(function(d){return a.actionsPending++,d.change?void(a.actionsDone++,c(b)):b(common.USER_INTERRUPT)})):common.createRuntimeDir(function(){c(b)})}],function(c,d){c&&c===common.USER_WARNING&&d&&d.msg&&log.printMessagesInBox(d.msg,common.LOG_COLORS.DEFAULT_BOX),a.auto&&c===common.USER_INTERRUPT&&(c=null),b(c,a)})};