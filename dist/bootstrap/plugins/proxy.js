'use strict';var url=require('url'),fs=require('fs-extra'),waterfall=require('async/waterfall'),log=require('fedtools-logs'),inquirer=require('inquirer'),common=require('../../common');module.exports=function(a,b){function c(b){inquirer.prompt([{type:'list',name:'protocol',message:'Select the proxy protocol:',choices:['http','https','other']},{type:'input',name:'protocol',message:'Type the protocol you want to use: ',when:function when(a){return'other'===a.protocol},validate:function validate(a){return!!a||'Protocol cannot be empty...'},filter:function filter(a){return a.replace('://','')}},{type:'list',name:'port',message:'Select the proxy port:',choices:['8080','80',{value:'',name:'none'},'other']},{type:'input',name:'port',message:'Type the port you want to use (<enter> for none): ',when:function when(a){return'other'===a.port}},{type:'input',name:'url',message:'Type the proxy URL: ',validate:function validate(a){return!!a||'URL cannot be empty...'}}]).then(function(c){var d=url.parse(c.url),f=c.url,g=c.protocol+'://',h=''===c.port?null:':'+c.port;d&&d.protocol&&(d.protocol&&('http:'===d.protocol||'https:'===d.protocol)?(g=d.protocol+'//',d.port&&(h=':'+d.port),d.hostname&&(f=d.hostname)):f=f.split(':')[0]);var i=g+f+h;return i?(fs.writeFileSync(common.ENVTOOLS.PROXY_FILE,i),log.echo(),log.success('proxy set to '+i),log.echo(),e.push('To take your proxy into account, you need to restart your session.'),process.env.ENVTOOLS_VERSION&&(e.push(''),e.push(log.strToColor('cyan','Hint #1:')+' type r ENTER or just restart your terminal...'),e.push(log.strToColor('cyan','Hint #2:')+' type pon ENTER to turn the proxy ON.'),e.push(log.strToColor('cyan','Hint #3:')+' type poff ENTER to turn the proxy OFF.')),a.auto&&fs.writeFileSync(common.ENVTOOLS.RESUME_AUTO,''),a.msg=e,b(common.USER_WARNING,a)):a.auto?b(null,a):b(common.USER_INTERRUPT,a)})}var d,e=[],f='';return a.auto&&fs.existsSync(common.ENVTOOLS.PROXY_FILE)?b(null,a):void waterfall([function(b){return d=[{type:'confirm',name:'goForIt',message:'Do you need to setup a proxy?',default:!0}],a.auto?void inquirer.prompt(d).then(function(c){return a.actionsPending++,c.goForIt?(a.actionsDone++,b()):b(common.USER_INTERRUPT)}):b()},function(b){fs.existsSync(common.ENVTOOLS.PROXY_FILE)?(f=fs.readFileSync(common.ENVTOOLS.PROXY_FILE,'utf8'),f&&''!==f&&(d=[{type:'confirm',name:'change',message:'Proxy already set... Do you want to change it?',default:!1}]),inquirer.prompt(d).then(function(d){return a.actionsPending++,d.change?void(a.actionsDone++,c(b)):b(common.USER_INTERRUPT)})):common.createRuntimeDir(function(){c(b)})}],function(c,d){c&&c===common.USER_WARNING&&d&&d.msg&&log.printMessagesInBox(d.msg,common.LOG_COLORS.DEFAULT_BOX),a.auto&&c===common.USER_INTERRUPT&&(c=null),b(c,a)})};