'use strict';const _=require('lodash'),fs=require('fs-extra'),waterfall=require('async/waterfall'),inquirer=require('inquirer'),path=require('path'),download=require('download'),log=require('fedtools-logs'),cmd=require('fedtools-commands'),fixUsrLocal=require('./usrlocal'),common=require('../../common');module.exports=function(a,b){let c=!1;return'darwin'===process.platform?void waterfall([function(a){const b=cmd.run('which brew',{status:!1}).output;_.isString(b)&&(c=!0),a()},function(b){const d={type:'confirm',name:'goForIt',default:!0};d.message=c?'About to update Homebrew, continue?':'About to install Homebrew, continue?',inquirer.prompt(d).then(function(c){return a.actionsPending++,c.goForIt?(a.actionsDone++,b(null,1)):b(null,0)})},function(b,c){return b?void fixUsrLocal(a,function(){c(null,b)}):c(null,b)},function(b,d){const e=path.join(common.RUNTIME_DIR,'homebrew');return b?void(c?cmd.run('brew update',{status:!a.auto},function(a,b){a&&b&&log.echo(b),d(a)}):download('https://github.com/Homebrew/homebrew/tarball/master',e,{mode:'755',extract:!0,strip:1}).then(function(){fs.copy(e,'/usr/local',function(b){return b?(log.error('Unable to install Homebrew...'),d(b)):void cmd.run('brew update',{status:!a.auto},function(a,b){a&&b&&log.echo(b),d(a)})})},function(a){return log.error('Unable to download Homebrew...'),log.echo(a),d(a)})):d(common.USER_INTERRUPT)},function(a){fs.writeFile(path.join(process.env.HOME,'.gemrc'),'gem: -n/usr/local/bin',{flag:'w'},a)},function(b){cmd.run('brew install wget',{status:!a.auto},function(a,c){a&&c&&log.error(c),b(a)})}],function(c){c&&(c===common.USER_INTERRUPT||c===common.USER_IGNORE)&&(c=null),b(c,a)}):(log.warning('Homebrew can only be installed on Mac.'),a.auto?b(null,a):b(common.USER_FATAL,a))};