'use strict';var fs=require('fs-extra'),path=require('path'),waterfall=require('async/waterfall'),parallel=require('async/parallel'),inquirer=require('inquirer'),cmd=require('fedtools-commands'),log=require('fedtools-logs'),backup=require('../../backup'),common=require('../../common'),promptForRestart=!1,NPM_CONFIG=path.join(process.env.HOME,'.npmrc'),YARN_CONFIG=path.join(process.env.HOME,'.yarnrc'),YARN_DEST=path.join(process.env.HOME,'.yarn'),YARN_TAR_GZ=path.join(common.ENVTOOLS.THIRDDIR,'yarn','latest.tar.gz'),YARN_BIN='yarn',NA='N/A',NPM_REGISTRY=process.env.CUSTOM_NPM_REGISTRY||'http://registry.npmjs.org/',YARN_REGISTRY=process.env.CUSTOM_NPM_REGISTRY||'http://registry.yarnpkg.com';module.exports=function(a,b){function c(a,b){var c=[];a?c=a:(c.push('Yarn has been automatically installed for you.'),c.push('You need to restart your session to use it.')),process.env.ENVTOOLS_VERSION&&(c.push(''),c.push(log.strToColor('cyan','Hint:')+' type r ENTER or just restart your terminal...')),log.echo(),log.printMessagesInBox(c,b?b:common.LOG_COLORS.NOTICE)}function d(a,b){var c=NA;cmd.run(a,{status:!1},function(a,d,e){return!a&&e&&(c=e.replace(/\n$/,'')),c&&'undefined'!==c&&'null'!==c||(c=NA),b(null,c)})}var e,f;backup([NPM_CONFIG,YARN_CONFIG]),waterfall([function(a){fs.emptyDir(YARN_DEST,function(){return a(null)})},function(a){fs.mkdirp(YARN_DEST,function(b){return a(null,b)})},function(a,b){return a||common.isWindows()?b(null):void cmd.run('tar zxf '+YARN_TAR_GZ+' -C '+YARN_DEST+' --strip 1',{status:!1},function(a){a||(YARN_BIN=path.join(process.env.HOME,'.yarn','bin','yarn'),promptForRestart=!0),b(null)})},function(b){inquirer.prompt({type:'confirm',name:'goForIt',message:'About to update npm and yarn configuration, continue?',default:!0}).then(function(c){return a.actionsPending++,c.goForIt?(a.actionsDone++,b(null,1)):b(null,0)})},function(a,b){return a?void d('yarn config get registry',function(c,d){f=d,b(c,a)}):b(null,a)},function(a,b){return a?void d('npm config get registry',function(c,d){e=d,b(c,a)}):b(null,a)},function(b,c){b&&parallel([function(b){var c;c=process.env.SINOPIA_STATUS&&process.env.SINOPIA_STATUS===common.ON?'npm config set registry http://localhost:4873/':e===NA?'npm config set registry='+NPM_REGISTRY:null,c?cmd.run(c,{status:!a.auto},b):b()},function(b){var c;c=f===NA?YARN_BIN+' config set registry '+YARN_REGISTRY:null,c?cmd.run(c,{status:!a.auto},b):b()},function(b){cmd.run('npm config set strict-ssl false',{status:!a.auto},function(){b()})},function(b){var c=YARN_BIN+' config set strict-ssl false';cmd.run(c,{status:!a.auto},function(){b()})}],function(a){c(a)})}],function(d){promptForRestart&&c(),a.auto&&d===common.USER_INTERRUPT&&(d=null),d||a.auto||(d=common.USER_IGNORE),b(d,a)})};