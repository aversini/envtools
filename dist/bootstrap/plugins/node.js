'use strict';const _=require('lodash'),fs=require('fs-extra'),path=require('path'),waterfall=require('async/waterfall'),inquirer=require('inquirer'),cmd=require('fedtools-commands'),semver=require('semver'),log=require('fedtools-logs'),utilities=require('fedtools-utilities'),backup=require('../../backup'),common=require('../../common'),NPM_CONFIG=path.join(process.env.HOME,'.npmrc'),YARN_CONFIG=path.join(process.env.HOME,'.yarnrc'),YARN_DEST=path.join(process.env.HOME,'.yarn'),YARN_TAR_GZ=path.join(common.ENVTOOLS.THIRDDIR,'yarn','latest.tar.gz'),NPM_PACKAGES=[{value:['eslint','eslint-plugin-react'],short:'eslint',name:'[eslint] ...... Pattern checker/linter for JavaScript.'},{value:'fastlint',short:'fastlint',name:'[fastlint] .... Linter helper.'},{value:'fedtools',short:'fedtools',name:'[fedtools] .... Framework code builder.'},{value:'grunt-cli',short:'grunt-cli',name:'[grunt-cli] ... The grunt command line interface.'},{value:'gulp-cli',short:'gulp-cli',name:'[gulp-cli] .... The gulp command line interface.'},{value:'npm-check',short:'npm-check',name:'[npm-check] ... Check for outdated, incorrect, and unused dependencies.'},{value:'selleck',short:'selleck',name:'[selleck] ..... YUI documentation generator.'},{value:'serve',short:'serve',name:'[serve]  ...... Static server.'},{value:'sinopia',short:'sinopia',name:'[sinopia] ..... Private npm repository server.'},{value:'surge',short:'surge',name:'[surge] ....... Static web publishing.'},{value:'svgo',short:'svgo',name:'[svgo] ........ Tool for optimizing SVG files.'},{value:'unicorn-tool',short:'unicorn',name:'[unicorn] ..... Framework code builder.'},{value:'yogi',short:'yogi',name:'[yogi] ........ YUI gallery code builder.'},{value:'yuidocjs',short:'yuidocjs',name:'[yuidocjs] .... YUI JavaScript Documentation engine.'}];let promptForRestart=!1,YARN_BIN='yarn',isYarn=utilities.isAppInstalled({name:'yarn'});function _displayNodeWarningWithProxy(a){const b=fs.existsSync(common.ENVTOOLS.PROXY_FILE),c=semver.gte(process.version,'6.0.0'),d=process.env.SINOPIA_STATUS===common.ON||process.env.SINOPIA_STATUS===common.OFF,e=[];return b&&c&&!d&&!isYarn?(e.push(log.strToColor('red','                         W A R N I N G\n')),e.push('It seems that you have a proxy and are using Node v5 or higher...'),e.push(`There is a known issue that may render your ${log.strToColor('cyan','npm install')} commands`),e.push(`extremelly slow... It is recommended that you ${log.strToColor('red','do not install')} any`),e.push(`node packages before installing ${log.strToColor('cyan','yarn')} (a replacement for npm).`),e.push(''),e.push('Please see installation guides for your OS here: '),e.push(log.strToColor('cyan','https://yarnpkg.com/en/docs/install')),e.push(''),e.push('Thanks!'),log.printMessagesInBox(e),a(1)):a()}module.exports=function(a,b){function c(a,b){let c=[];a?c=a:(c.push('Yarn has been automatically installed for you.'),c.push('You need to restart your session to use it.')),process.env.ENVTOOLS_VERSION&&(c.push(''),c.push(`${log.strToColor('cyan','Hint:')} type r ENTER or just restart your terminal...`)),log.echo(),log.printMessagesInBox(c,b?b:common.LOG_COLORS.NOTICE)}backup([NPM_CONFIG,YARN_CONFIG]),waterfall([function(a){return isYarn?a(null,!1):void fs.mkdirp(YARN_DEST,function(b){return a(null,b)})},function(a,b){return isYarn||a||common.isWindows()?b(null):void cmd.run(`tar zxf ${YARN_TAR_GZ} -C ${YARN_DEST} --strip 1`,{status:!1},function(a){a||(YARN_BIN=path.join(process.env.HOME,'.yarn','bin','yarn'),isYarn=!0,promptForRestart=!0),b(null)})},function(b){const c={type:'confirm',name:'goForIt',message:isYarn?'About to update npm and yarn configuration, continue?':'About to update npm configuration, continue?',default:!0};inquirer.prompt(c).then(function(c){return a.actionsPending++,c.goForIt?(a.actionsDone++,b(null,1)):b(null,0)})},function(b,c){return b?void cmd.run('npm config set strict-ssl false',{status:!a.auto},function(){c(null,b)}):c(null,b)},function(b,c){let d;return b&&isYarn?void(d=`${YARN_BIN} config set strict-ssl false`,cmd.run(d,{status:!a.auto},function(){c()})):c()},function(b){const c={type:'confirm',name:'goForIt',message:'Continue?',default:!1};_displayNodeWarningWithProxy(function(d){return!a.auto&&d?void inquirer.prompt(c).then(function(a){return a.goForIt?b():b(common.USER_INTERRUPT)}):b()})},function(b){return a.auto?void inquirer.prompt({type:'confirm',name:'goForIt',message:'About to install core node packages, continue?',default:!0}).then(function(c){return a.actionsPending++,c.goForIt?(a.actionsDone++,b(null,1)):b(null,0)}):b(null,1)},function(b,c){if(!b)return c(common.USER_INTERRUPT);else if(!a.auto)inquirer.prompt([{type:'checkbox',message:'Select one or more node packages you want to install',name:'npms',choices:NPM_PACKAGES,pageSize:NPM_PACKAGES.length+1,validate(a){return!!a.length||'Press <space> to select one or more packages, or <ctrl-c> to quit...'}}]).then(function(a){return c(null,a.npms)});else return c(null,_.map(NPM_PACKAGES,function(a){return a.value}))},function(a,b){return a&&a.length?common.installNpmPackages(_.flatten(a),isYarn,YARN_BIN,b):b(common.USER_INTERRUPT)}],function(d){promptForRestart&&c(),a.auto&&d===common.USER_INTERRUPT&&(d=null),d||a.auto||(d=common.USER_IGNORE),b(d,a)})};