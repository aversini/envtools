"use strict";const _=require("lodash"),cmd=require("fedtools-commands"),log=require("fedtools-logs"),waterfall=require("async/waterfall"),inquirer=require("inquirer"),bootstrapHomebrew=require("./homebrew"),common=require("../../common");module.exports=function(a,b){function c(b){return"darwin"===process.platform?void(h?cmd.run("brew install ruby",{status:!a.auto},b):bootstrapHomebrew(a,function(c){c||cmd.run("brew install ruby",{status:!a.auto},b)})):(log.notice("Cannot find Ruby (ruby), please install it manually."),b(common.USER_INTERRUPT))}function d(b){let c;return j?void(c="darwin"===process.platform?"gem install --no-ri --no-rdoc compass --install-dir /usr/local/gems":"sudo -E gem install --no-ri --no-rdoc compass",cmd.run(c,{status:!a.auto},b)):(log.notice("Cannot find Rubygems (gem), please install it manually."),b(common.USER_INTERRUPT))}function e(a){const b=cmd.run("ruby -v",{status:!1}).output,c=b.split(" ")[1].slice(0,5).split("."),d=+c[0],e=+c[1];return 1<d||1>=d&&e>8?a():a(1)}function f(a){const b=cmd.run("compass -v",{status:!1}).output,c=+b.split(" ")[1].charAt(0);return 1<=c?a():a(1)}let g,h,i,j;waterfall([function(b){inquirer.prompt({message:"About to install/update Ruby and Compass, continue?",type:"confirm",name:"goForIt",default:!0}).then(function(c){return a.actionsPending++,c.goForIt?(a.actionsDone++,b()):b(common.USER_INTERRUPT)})},function(a){g=cmd.run("which ruby",{status:!1}).output,h=cmd.run("which brew",{status:!1}).output,i=cmd.run("which compass",{status:!1}).output,j=cmd.run("which gem",{status:!1}).output,a()},function(a){_.isString(g)?e(function(b){return b?void c(a):a()}):c(a)},function(a){_.isString(i)?f(function(b){return b?void d(a):a()}):d(a)}],function(c){a.auto&&c===common.USER_INTERRUPT&&(c=null),b(c,a)})};